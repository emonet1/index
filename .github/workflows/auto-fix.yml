name: ğŸ¤– AI è‡ªåŠ¨ä¿®å¤

on:
  issues:
    types: [opened, reopened]

jobs:
  ai-fix:
    if: contains(github.event.issue.labels.*.name, 'auto-fix')
    runs-on: ubuntu-latest
    
    # å¼ºåˆ¶å¼€å¯æƒé™å£°æ˜
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ä½ çš„ PAT ç¡®ä¿å¯ä»¥åˆ›å»ºå¹¶æ¨é€æ–°åˆ†æ”¯
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ¤– AI åˆ†æå¹¶ç”Ÿæˆä¿®å¤ä»£ç 
        id: ai-fix
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          pip install requests
          python .github/scripts/ai_fix.py
      
      - name: ğŸ“ åˆ›å»º Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          # âœ… å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ PAT ç»•è¿‡æ‰€æœ‰ UI æƒé™é™åˆ¶
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          commit-message: "ğŸ¤– AI è‡ªåŠ¨ä¿®å¤: Issue #${{ github.event.issue.number }}"
          branch: "auto-fix/issue-${{ github.event.issue.number }}"
          delete-branch: true
          title: "ğŸ¤– [AI-FIX] ä¿®å¤ Issue #${{ github.event.issue.number }}"
          body: |
            ## ğŸ¤– AI è‡ªåŠ¨ä¿®å¤æŠ¥å‘Š
            æ­¤ PR ç”± AI è‡ªåŠ¨ç”Ÿæˆï¼Œç”¨äºä¿®å¤ #${{ github.event.issue.number }}
            Closes #${{ github.event.issue.number }}
          labels: |
            auto-fix
            automated-pr
      
      - name: ğŸ’¬ åœ¨ Issue ä¸­è¯„è®º
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **AI ä¿®å¤å·²å®Œæˆï¼**\n\nğŸ”— ä¿®å¤ PR: #${{ steps.create-pr.outputs.pull-request-number }}`
            })

      - name: âŒ ä¿®å¤å¤±è´¥é€šçŸ¥
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **AI ä¿®å¤å¤±è´¥**\nè¯·æ£€æŸ¥ [Actions æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })
