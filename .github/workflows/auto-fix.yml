name: ğŸ¤– AI è‡ªåŠ¨ä¿®å¤

# è§¦å‘æ¡ä»¶ï¼šå½“åˆ›å»ºæˆ–é‡æ–°æ‰“å¼€ Issue æ—¶
on:
  issues:
    types: [opened, reopened]

jobs:
  ai-fix:
    # åªå¤„ç†å¸¦æœ‰ auto-fix æ ‡ç­¾çš„ Issue
    if: contains(github.event.issue.labels.*.name, 'auto-fix')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: ğŸ¤– AI åˆ†æå¹¶ç”Ÿæˆä¿®å¤ä»£ç 
        id: ai-fix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          python .github/scripts/ai_fix.py
      
      - name: ğŸ“ åˆ›å»º Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ¤– AI è‡ªåŠ¨ä¿®å¤: Issue #${{ github.event.issue.number }}"
          branch: "auto-fix/issue-${{ github.event.issue.number }}"
          delete-branch: true
          title: "ğŸ¤– [AI-FIX] ä¿®å¤ Issue #${{ github.event.issue.number }}"
          body: |
            ## ğŸ¤– AI è‡ªåŠ¨ä¿®å¤æŠ¥å‘Š
            
            æ­¤ PR ç”± AI è‡ªåŠ¨ç”Ÿæˆï¼Œç”¨äºä¿®å¤ #${{ github.event.issue.number }}
            
            ### ğŸ“‹ ä¿®å¤å†…å®¹
            - âœ… å·²åˆ†æé”™è¯¯æ—¥å¿—
            - âœ… AI å·²ç”Ÿæˆä¿®å¤ä»£ç 
            - âœ… ä»£ç å·²é€šè¿‡åŸºç¡€æ£€æŸ¥
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - è¯·ä»”ç»†å®¡æŸ¥ä¿®å¤ä»£ç 
            - ç¡®è®¤æ— è¯¯åå†åˆå¹¶
            - åˆå¹¶åå°†è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨
            
            ### ğŸ”— ç›¸å…³ Issue
            Closes #${{ github.event.issue.number }}
            
            ---
            > ğŸ¤– æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º
            > ğŸ• åˆ›å»ºæ—¶é—´: ${{ github.event.issue.created_at }}
          labels: |
            auto-fix
            automated-pr
      
      - name: ğŸ’¬ åœ¨ Issue ä¸­è¯„è®º
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **AI ä¿®å¤å·²å®Œæˆï¼**
              
              ğŸ”— ä¿®å¤ PR: #${{ steps.create-pr.outputs.pull-request-number }}
              
              è¯·å‰å¾€ PR é¡µé¢å®¡æŸ¥ä¿®å¤ä»£ç ï¼Œç¡®è®¤æ— è¯¯åå¯ä»¥åˆå¹¶ã€‚
              
              åˆå¹¶åå°†è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨å¹¶é‡å¯ç›¸å…³æœåŠ¡ã€‚`
            })
      
      - name: âŒ ä¿®å¤å¤±è´¥é€šçŸ¥
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **AI ä¿®å¤å¤±è´¥**
              
              è¯·æ£€æŸ¥ [Actions æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚
              
              å¯èƒ½çš„åŸå› ï¼š
              - AI API è°ƒç”¨å¤±è´¥
              - ä»£ç è§£æé”™è¯¯
              - æƒé™é…ç½®é—®é¢˜`
            })
