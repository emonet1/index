name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    # åªæœ‰å½“ PR åˆå¹¶ä¸”åŒ…å« 'auto-fix' æ ‡ç­¾ï¼Œæˆ–äººå·¥åˆå¹¶æ—¶è§¦å‘
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨
        uses: easingthemes/ssh-deploy@v5.1.0
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          ARGS: "-avz --delete --exclude='.git/' --exclude='.github/' --exclude='*.log' --exclude='monitor_*.log' --exclude='.env' --exclude='pb/pb_data/' --exclude='pb/pb_migrations/' --exclude='pb/logs/'"
          SOURCE: "./"
          REMOTE_HOST: ${{ secrets.SSH_HOST }}
          REMOTE_USER: ${{ secrets.SSH_USER }}
          TARGET: "/home/"
          # è§£é‡Šï¼š
          # --exclude='pb/pb_data/'       : ç»å¯¹ä¿æŠ¤ SQLite æ•°æ®åº“ä¸è¢«è¦†ç›–
          # --exclude='pb/pb_migrations/' : ä¿æŠ¤æœåŠ¡å™¨ç«¯ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶
          # --exclude='.env'              : ä¿æŠ¤æœåŠ¡å™¨ç¯å¢ƒå˜é‡é…ç½®
          # --exclude='*.log'             : ä¸è¦†ç›–æˆ–åˆ é™¤æœåŠ¡å™¨æ—¥å¿—

      - name: ğŸ”„ é‡å¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ ä»£ç å·²éƒ¨ç½²ï¼Œæ­£åœ¨é‡å¯æœåŠ¡..."
            
            # æ£€æŸ¥ supervisorctl æ˜¯å¦å¯ç”¨
            if ! command -v supervisorctl &> /dev/null; then
              echo "âš ï¸ supervisorctl æœªå®‰è£…ï¼Œè·³è¿‡æœåŠ¡é‡å¯"
              exit 0
            fi
            
            # å•ç‹¬é‡å¯æ¯ä¸ªæœåŠ¡ï¼Œè®°å½•ç»“æœ
            RESTART_FAILED=0
            
            echo "é‡å¯ pocketbase..."
            if supervisorctl restart pocketbase; then
              echo "âœ… pocketbase é‡å¯æˆåŠŸ"
            else
              echo "âŒ pocketbase é‡å¯å¤±è´¥"
              RESTART_FAILED=1
            fi
            
            echo "é‡å¯ ai-proxy..."
            if supervisorctl restart ai-proxy; then
              echo "âœ… ai-proxy é‡å¯æˆåŠŸ"
            else
              echo "âŒ ai-proxy é‡å¯å¤±è´¥"
              RESTART_FAILED=1
            fi
            
            echo "é‡å¯ websocket..."
            if supervisorctl restart websocket; then
              echo "âœ… websocket é‡å¯æˆåŠŸ"
            else
              echo "âŒ websocket é‡å¯å¤±è´¥"
              RESTART_FAILED=1
            fi
            
            echo ""
            echo "ğŸ“Š æœåŠ¡çŠ¶æ€æ€»è§ˆï¼š"
            supervisorctl status
            
            if [ $RESTART_FAILED -eq 1 ]; then
              echo "âš ï¸ éƒ¨åˆ†æœåŠ¡é‡å¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
              exit 1
            fi
            
            echo "âœ… æ‰€æœ‰æœåŠ¡é‡å¯å®Œæˆ"
