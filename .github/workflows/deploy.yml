name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    # åªæœ‰å½“ PR åˆå¹¶ä¸”åŒ…å« 'auto-fix' æ ‡ç­¾ï¼Œæˆ–äººå·¥åˆå¹¶æ—¶è§¦å‘
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨
        uses: easingthemes/ssh-deploy@v5.1.0
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          ARGS: "-avz --delete --exclude='.git/' --exclude='.github/' --exclude='*.log' --exclude='monitor_*.log' --exclude='.env' --exclude='pb/pb_data/' --exclude='pb/pb_migrations/' --exclude='pb/logs/'"
          SOURCE: "./"
          REMOTE_HOST: ${{ secrets.SSH_HOST }}
          REMOTE_USER: ${{ secrets.SSH_USER }}
          TARGET: "/home/"
          # è§£é‡Šï¼š
          # --exclude='pb/pb_data/'       : ç»å¯¹ä¿æŠ¤ SQLite æ•°æ®åº“ä¸è¢«è¦†ç›–
          # --exclude='pb/pb_migrations/' : ä¿æŠ¤æœåŠ¡å™¨ç«¯ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶
          # --exclude='.env'              : ä¿æŠ¤æœåŠ¡å™¨ç¯å¢ƒå˜é‡é…ç½®
          # --exclude='*.log'             : ä¸è¦†ç›–æˆ–åˆ é™¤æœåŠ¡å™¨æ—¥å¿—

      - name: ğŸ”„ é‡å¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ ä»£ç å·²éƒ¨ç½²ï¼Œæ­£åœ¨é‡å¯æœåŠ¡..."
            # å°è¯•é‡å¯æ‰€æœ‰ç›¸å…³æœåŠ¡
            supervisorctl restart pocketbase ai-proxy websocket || true
            supervisorctl status
            echo "âœ… æœåŠ¡é‡å¯å®Œæˆ"
