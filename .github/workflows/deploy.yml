name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

# è§¦å‘æ¡ä»¶ï¼šå½“ PR è¢«å…³é—­æ—¶
on:
  pull_request:
    types: [closed]

jobs:
  deploy:
    # åªåœ¨ PR åˆå¹¶ä¸”å¸¦æœ‰ auto-fix æ ‡ç­¾æ—¶æ‰§è¡Œ
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'auto-fix')
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: ğŸ” é…ç½® SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: ğŸ“ æ·»åŠ æœåŠ¡å™¨åˆ° known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: ğŸ“¦ åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨
        run: |
          echo "å¼€å§‹åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨..."
          
          rsync -avz --delete \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='node_modules/' \
            --exclude='__pycache__/' \
            --exclude='*.pyc' \
            --exclude='.DS_Store' \
            --progress \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/home/
          
          echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
      
      - name: ğŸ”„ é‡å¯æœåŠ¡
        run: |
          echo "å¼€å§‹é‡å¯æœåŠ¡..."
          
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            # æå–æœåŠ¡åç§°ï¼ˆä» PR æ ‡é¢˜ï¼‰
            SERVICE_NAME="${{ github.event.pull_request.title }}"
            
            # é‡å¯æ‰€æœ‰ç›¸å…³æœåŠ¡ï¼ˆç®€åŒ–å¤„ç†ï¼‰
            echo "é‡å¯ supervisor ç®¡ç†çš„æœåŠ¡..."
            supervisorctl restart pocketbase websocket ai-proxy || true
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š"
            supervisorctl status
            
            echo "âœ… æœåŠ¡é‡å¯å®Œæˆ"
          ENDSSH
      
      - name: ğŸ’¬ åœ¨ PR ä¸­è¯„è®º
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ‰ **éƒ¨ç½²æˆåŠŸï¼**
              
              âœ… ä»£ç å·²åŒæ­¥åˆ°æœåŠ¡å™¨
              âœ… ç›¸å…³æœåŠ¡å·²é‡å¯
              âœ… æœåŠ¡è¿è¡Œæ­£å¸¸
              
              ---
              ğŸ“… éƒ¨ç½²æ—¶é—´: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
              ğŸ”— éƒ¨ç½²æ—¥å¿—: [æŸ¥çœ‹è¯¦æƒ…](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });
      
      - name: ğŸ’¬ å…³é—­å…³è”çš„ Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prBody = context.payload.pull_request.body || '';
            const issueMatch = prBody.match(/#(\d+)/);
            
            if (issueMatch) {
              const issueNumber = parseInt(issueMatch[1]);
              
              // åœ¨ Issue ä¸­è¯„è®º
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ğŸ‰ **ä¿®å¤å·²éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼**
                
                âœ… ä¿®å¤ PR #${context.payload.pull_request.number} å·²åˆå¹¶å¹¶éƒ¨ç½²
                âœ… æœåŠ¡å·²é‡å¯å¹¶æ­£å¸¸è¿è¡Œ
                
                æ­¤ Issue ç°å·²è‡ªåŠ¨å…³é—­ã€‚å¦‚é—®é¢˜ä»å­˜åœ¨ï¼Œè¯·é‡æ–°æ‰“å¼€ã€‚`
              });
              
              // å…³é—­ Issue
              await github.rest.issues.update({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });
            }
      
      - name: âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **éƒ¨ç½²å¤±è´¥ï¼**
              
              è¯·æŸ¥çœ‹ [éƒ¨ç½²æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚
              
              å¯èƒ½çš„åŸå› ï¼š
              - SSH è¿æ¥å¤±è´¥
              - æ–‡ä»¶åŒæ­¥é”™è¯¯
              - æœåŠ¡é‡å¯å¤±è´¥
              
              è¯·æ‰‹åŠ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ã€‚`
            });
