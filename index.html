<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>眼动追踪数据收集系统 - 官方校准</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB6O5l6uZa-6sywCZTGRJx2CKPuq3KeBF0",
            authDomain: "index-9f58d.firebaseapp.com",
            projectId: "index-9f58d",
            storageBucket: "index-9f58d.appspot.com",
            messagingSenderId: "718279245978",
            appId: "1:718279245978:web:93a9a07473ad8d3e6a5f23"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const userId = 'index';
        console.log('会话ID:', sessionId);
        console.log('用户ID:', userId);

        async function loadWebGazerScript() {
            const source = 'https://webgazer.cs.brown.edu/webgazer.js';
            try {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = source;
                    script.onload = resolve;
                    script.onerror = () => reject(new Error(`无法从 ${source} 加载WebGazer`));
                    document.head.appendChild(script);
                });
                console.log(`WebGazer从 ${source} 加载成功`);
                return true;
            } catch (error) {
                console.error(`加载失败: ${error.message}`);
                return false;
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: #f0f0f0; }
        #heatmapContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1000; opacity: 0.7; visibility: hidden; }
        #plotting_canvas { position: fixed; top: 0; left: 0; cursor: crosshair; z-index: 900; pointer-events: none; opacity: 0.5; }
        #content { position: relative; z-index: 1; padding: 50px; max-width: 800px; margin: 20px auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #statsPanel { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.85); color: white; padding: 10px 15px; border-radius: 10px; z-index: 2000; width: 280px; font-size: 12px; }
        .stat-item { margin: 8px 0; display: flex; justify-content: space-between; }
        .stat-value { font-weight: bold; color: #4CAF50; }
        #debugPanel { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.9); color: #00ff00; padding: 15px; border-radius: 8px; z-index: 2000; max-width: 350px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; display: none; }
        .test-area { height: 150px; margin: 30px 0; padding: 20px; border-radius: 10px; border: 2px solid #ddd; cursor: pointer; transition: all 0.3s ease; }
        .test-area:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .area-blue { background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; }
        .area-green { background: linear-gradient(135deg, #00b894, #00a085); color: white; }
        .area-orange { background: linear-gradient(135deg, #fdcb6e, #e17055); color: white; }
        .controls { text-align: center; margin: 30px 0; }
        .btn { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 0 10px; font-size: 16px; transition: background 0.3s; }
        .btn:hover { background: #45a049; }
        .btn.danger { background: #f44336; }
        .btn.danger:hover { background: #da190b; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status { position: fixed; top: 20px; left: 20px; padding: 10px 15px; border-radius: 20px; font-weight: bold; z-index: 2000; }
        .status.ready { background: #4CAF50; color: white; } .status.calibrating { background: #ff9800; color: white; } .status.error { background: #f44336; color: white; } .status.initializing { background: #2196F3; color: white; } .status.loading { background: #9C27B0; color: white; }
        #webgazerVideoContainer { position: fixed !important; top: 10px !important; right: 320px !important; z-index: 1999 !important; width: 240px !important; height: 180px !important; }
        #webgazerVideoFeed, #webgazerFaceOverlay, #webgazerFaceFeedbackBox { border-radius: 8px !important; border: 2px solid #4CAF50 !important; }
        .Calibration { background-color: red; border: solid 2px #fff; border-radius: 50%; width: 25px; height: 25px; position: fixed; z-index: 100000; cursor: pointer; }
        #Pt1 { top: 5vh; left: 5vw; } #Pt2 { top: 5vh; left: 50vw; } #Pt3 { top: 5vh; left: 95vw; }
        #Pt4 { top: 50vh; left: 5vw; } #Pt5 { top: 50vh; left: 50vw; } #Pt6 { top: 50vh; left: 95vw; }
        #Pt7 { top: 95vh; left: 5vw; } #Pt8 { top: 95vh; left: 50vw; } #Pt9 { top: 95vh; left: 95vw; }
        #Accuracy { background-color: #222; color: white; padding: 8px; border-radius: 5px; text-align: center; }
        .collection-status { margin-top: 10px; padding: 8px; border-radius: 5px; text-align: center; }
        .collection-status.connected { background: #4CAF50; color: white; } .collection-status.disconnected { background: #f44336; color: white; } .collection-status.uploading { background: #ff9800; color: white; }
        .firebase-status { margin-top: 8px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px; }
        .heatmap-visible { opacity: 0.7 !important; visibility: visible !important; }
    </style>
</head>
<body>
    <div id="status" class="status loading">正在加载库文件...</div>
    <canvas id="plotting_canvas" width="500" height="500"></canvas>

    <div id="statsPanel">
        <h4 style="margin: 0 0 10px 0; text-align: center; color: #4CAF50;">📊 眼动数据统计</h4>
        <div class="stat-item"><span>会话ID:</span><span id="sessionIdDisplay" class="stat-value" style="font-size: 10px; word-break: break-all;"></span></div>
        <div class="stat-item"><span>注视点总数:</span><span id="totalGazes" class="stat-value">0</span></div>
        <div class="stat-item"><span>眼跳次数:</span><span id="saccadeCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>注视次数:</span><span id="fixationCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>平均注视时间:</span><span id="avgFixationTime" class="stat-value">0ms</span></div>
        <div class="stat-item"><span>运行时间:</span><span id="runningTime" class="stat-value">0s</span></div>
        <div id="Accuracy">尚未校准</div>
        <div class="stat-item"><span>系统状态:</span><span id="systemStatus" class="stat-value">加载中</span></div>
        <div class="collection-status disconnected" id="collectionStatus">📈 数据收集: 未开始</div>
        <div class="firebase-status disconnected" id="firebaseStatus">🔥 Firebase: 未连接</div>
        <button class="btn test" onclick="testFirebaseConnection()" style="width: 100%; margin: 8px 0 0 0; padding: 6px; font-size: 12px;">🧪 测试连接</button>
        <button class="btn toggle" onclick="toggleHeatmap()" style="width: 100%; margin-top: 5px; padding: 6px; font-size: 12px;">🔥 显示热力图</button>
        <button class="btn test" onclick="toggleDebug()" style="width: 100%; margin-top: 5px; padding: 6px; font-size: 12px;">🐛 显示调试</button>
    </div>

    <div id="debugPanel"><div id="debugInfo">调试信息将在这里显示...</div></div>
    <div id="heatmapContainer"></div>
    <div class="calibrationDiv">
        <input type="button" class="Calibration" id="Pt1"></input>
        <input type="button" class="Calibration" id="Pt2"></input>
        <input type="button" class="Calibration" id="Pt3"></input>
        <input type="button" class="Calibration" id="Pt4"></input>
        <input type="button" class="Calibration" id="Pt5"></input>
        <input type="button" class="Calibration" id="Pt6"></input>
        <input type="button" class="Calibration" id="Pt7"></input>
        <input type="button" class="Calibration" id="Pt8"></input>
        <input type="button" class="Calibration" id="Pt9"></input>
    </div>

    <div id="content">
        <h1 style="text-align: center; color: #333;">👁️ 眼动追踪数据收集系统 - 官方校准版</h1>
        <div class="controls">
            <button class="btn" id="startBtn" onclick="startEyeTracking()" disabled>🚀 启动眼动追踪</button>
            <button class="btn" id="calibrateBtn" onclick="Restart()" disabled>🎯 开始/重新校准</button>
            <button class="btn danger" onclick="stopTracking()">⏹️ 停止追踪</button>
        </div>
        <p style="text-align: center; font-size: 18px; color: #666; margin: 30px 0;">校准完成后，请在页面上<strong style="color: red;">自由点击</strong>以开始测量精度。</p>
        <div class="test-area area-blue"><h2>🌊 区域 A</h2><p>请自然地浏览此区域。</p></div>
        <div class="test-area area-green"><h2>🌿 区域 B</h2><p>系统会记录您的眼动模式。</p></div>
        <div class="test-area area-orange"><h2>🔥 区域 C</h2><p>所有数据将被自动收集。</p></div>
    </div>

    <script>
        // ===========================================
        // 全局变量定义
        // ===========================================
        let heatmapInstance = null, gazeCount = 0, saccadeCount = 0, fixationCount = 0, totalFixationTime = 0;
        let startTime = Date.now();
        let isTracking = false, webgazerReady = false, debugMode = false, heatmapVisible = false, librariesLoaded = false, firebaseConnected = false;
        
        let eyeTrackingData = { gazePoints: [], saccades: [], fixations: [], calibrationData: { accuracy_percentage: null, timestamp: null } };
        let lastGazePoint = null;
        let autoSaveInterval = null, statsUpdateInterval = null;

        document.getElementById('sessionIdDisplay').textContent = sessionId;

        // ===================================================================================
        // START: OFFICIAL WEBGAZER DEMO LOGIC (DIRECTLY PORTED)
        // ===================================================================================

        var PointCalibrate = 0;
        var CalibrationPoints = {};

        // Precision measurement variables
        var precision_measurement = null;
        var store_points_variable = true;
        var points_data = [];
        var ClicksPerPoint = 5;

        /**
         * Clears all calibration points and resets the UI.
         */
        function ClearCalibration() {
            document.querySelectorAll('.Calibration').forEach(i => {
                i.style.backgroundColor = 'red';
                i.style.opacity = '0.2';
                i.style.display = 'none';
            });
            CalibrationPoints = {};
            PointCalibrate = 0;
        }

        /**
         * Resets calibration process and starts it. This is the main entry point for calibration.
         */
        function Restart() {
            if (!webgazerReady) {
                swal('错误', '请先启动眼动追踪。', 'error');
                return;
            }

            // Unbind precision measurement click listener
            document.onclick = null;
            store_points_variable = true;
            points_data = [];

            if (precision_measurement) clearInterval(precision_measurement);
            
            webgazer.clearData();
            ClearCalibration();
            
            swal({
                title: "开始校准",
                text: `请将视线聚焦在屏幕上出现的每个红点上，然后用鼠标左键点击该点。每个点需要点击 ${ClicksPerPoint} 次。`,
                button: "我准备好了！"
            }).then(() => {
                updateStatus('校准进行中', 'calibrating');
                document.getElementById('Accuracy').innerHTML = "校准中...";
                // Show the first calibration point
                document.getElementById('Pt1').style.display = 'block';
                document.getElementById('Pt1').style.opacity = '1';
            });
        }
        
        // Attaching click listeners to calibration points using the official for-loop method
        for (let i = 1; i <= 9; i++) {
            document.getElementById("Pt" + i).addEventListener("click", function() {
                const id = "Pt" + i;
                if (!CalibrationPoints[id]) CalibrationPoints[id] = 0;
                CalibrationPoints[id]++;

                if (CalibrationPoints[id] === ClicksPerPoint) {
                    this.style.backgroundColor = 'yellow';
                    this.setAttribute('disabled', 'disabled');
                    PointCalibrate++;
                } else if (CalibrationPoints[id] < ClicksPerPoint) {
                    // Animate the click
                    let opacity = 0.2 * CalibrationPoints[id] + 0.2;
                    this.style.opacity = opacity.toString();
                }

                if (PointCalibrate >= 9) {
                    // All points calibrated
                    ClearCalibration();
                    updateStatus('校准完成', 'ready');
                    swal('校准完成!', '现在请在屏幕的任意位置点击，系统将开始测量您的注视精度。', 'success');
                    
                    // Start precision measurement on click
                    store_points_variable = true;
                    document.onclick = store_points;
                }
            });
        }

        /**
         * Store the user's click and the predicted gaze location for precision calculation.
         */
        function store_points(event) {
            if (!store_points_variable) return;
            
            const x = event.clientX;
            const y = event.clientY;
            const gazePrediction = webgazer.getCurrentPrediction();
            if (gazePrediction) {
                points_data.push({
                    clickX: x, clickY: y,
                    gazeX: gazePrediction.x, gazeY: gazePrediction.y
                });
                
                if (!precision_measurement) {
                    precision_measurement = setInterval(calculatePrecision, 1000);
                }
            }
        }
        
        /**
         * Periodically calculates and displays the precision percentage.
         */
        function calculatePrecision() {
            if (points_data.length < 5) return;

            const thresholds = [100, 200, 300];
            let within_threshold = [0, 0, 0];

            points_data.forEach(point => {
                const distance = Math.sqrt(Math.pow(point.clickX - point.gazeX, 2) + Math.pow(point.clickY - point.gazeY, 2));
                thresholds.forEach((threshold, i) => {
                    if (distance <= threshold) within_threshold[i]++;
                });
            });
            
            let percentages = within_threshold.map(count => ((count / points_data.length) * 100).toFixed(1));
            
            const displayText = `精度(<${thresholds[0]}px): ${percentages[0]}%`;
            document.getElementById('Accuracy').innerHTML = displayText;
            
            eyeTrackingData.calibrationData.accuracy_percentage = percentages[0];
            eyeTrackingData.calibrationData.timestamp = new Date().toISOString();
        }

        // ===================================================================================
        // END: OFFICIAL WEBGAZER DEMO LOGIC
        // ===================================================================================

        // Helper and application-specific functions
        function debug(message) { /* ... no changes ... */ }
        function updateStatus(message, type) { /* ... no changes ... */ }
        async function testFirebaseConnection() { /* ... no changes ... */ }
        function processSaccadeAndFixation(gazePoint) { /* ... no changes ... */ }
        function updateStatsDisplay() { /* ... no changes ... */ }
        async function saveEyeTrackingData(isManual = false) { /* ... no changes ... */ }

        function gazeDataCallback(data, elapsedTime) {
            if (!isTracking || !data) return;
            const gazePoint = { x: data.x, y: data.y, timestamp: new Date().toISOString(), elapsedTime, sessionId, userId };
            eyeTrackingData.gazePoints.push(gazePoint);
            if (heatmapInstance) heatmapInstance.addData({ x: gazePoint.x, y: gazePoint.y, value: 5 });
            gazeCount++;
        }

        async function initializeSystem() {
            try {
                if (typeof h337 === 'undefined' || typeof swal === 'undefined') throw new Error('依赖库加载失败');
                if (!await loadWebGazerScript() || typeof webgazer === 'undefined') throw new Error('WebGazer加载失败');
                heatmapInstance = h337.create({ container: document.getElementById('heatmapContainer'), radius: 25, maxOpacity: 0.6, blur: 0.8 });
                await testFirebaseConnection();
                updateStatus('系统就绪', 'ready');
                document.getElementById('startBtn').disabled = false;
                librariesLoaded = true;
                ClearCalibration(); // Initially hide calibration points
            } catch (error) {
                updateStatus('初始化失败', 'error');
                swal('严重错误', `系统初始化失败:\n\n${error.message}`, 'error');
            }
        }

        async function startEyeTracking() {
            if (!librariesLoaded) return;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            updateStatus('初始化WebGazer...', 'initializing');
            try {
                const canvas = document.getElementById("plotting_canvas");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                canvas.style.position = 'fixed';

                await webgazer.setGazeListener(gazeDataCallback).begin();
                webgazer.showVideoPreview(true).showPredictionPoints(true).applyKalmanFilter(true);
                
                webgazerReady = true; isTracking = true; startTime = Date.now();
                if (firebaseConnected) autoSaveInterval = setInterval(() => saveEyeTrackingData(false), 10000);
                statsUpdateInterval = setInterval(() => {
                    if (isTracking) {
                        document.getElementById('runningTime').textContent = Math.round((Date.now() - startTime) / 1000) + 's';
                        updateStatsDisplay();
                    }
                }, 1000);
                
                updateStatus('运行中', 'ready');
                document.getElementById('calibrateBtn').disabled = false;
                startBtn.textContent = '✅ 运行中';
                swal('启动成功', '眼动追踪已启动！\n请点击 "开始/重新校准" 按钮以提高精度。', 'success');
            } catch (error) {
                updateStatus('启动失败', 'error');
                startBtn.disabled = false;
                swal('启动失败', `无法启动眼动追踪。\n请检查并允许浏览器使用摄像头。\n\n${error.message}`, 'error');
            }
        }

        function stopTracking() {
            if (!isTracking) return;
            swal({ title: "确认停止", text: "确定要停止追踪吗？", icon: "warning", buttons: true, dangerMode: true })
            .then((willStop) => { if (willStop) performStop(); });
        }
        
        async function performStop() {
            if (firebaseConnected) await saveEyeTrackingData(true);
            isTracking = false; webgazerReady = false;

            if (precision_measurement) clearInterval(precision_measurement);
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            if (statsUpdateInterval) clearInterval(statsUpdateInterval);
            
            document.onclick = null;
            store_points_variable = false;

            if (typeof webgazer !== 'undefined' && webgazer.isReady()) {
                // This is the official and correct way to stop WebGazer and release the camera.
                webgazer.end();
                debug("WebGazer.end() called. Camera should be off.");
            }

            ClearCalibration();
            updateStatus('已停止', 'error');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = '🚀 启动眼动追踪';
            document.getElementById('calibrateBtn').disabled = true;
            document.getElementById('Accuracy').innerHTML = "尚未校准";
            swal('已停止', '眼动追踪已停止，摄像头已关闭。', 'success');
        }

        function toggleDebug() { debugMode = !debugMode; document.getElementById('debugPanel').style.display = debugMode ? 'block' : 'none'; }
        function toggleHeatmap() { heatmapVisible = !heatmapVisible; document.getElementById('heatmapContainer').classList.toggle('heatmap-visible'); }
        
        window.addEventListener('load', initializeSystem);
        window.onbeforeunload = (e) => {
            if (isTracking && gazeCount > 0) {
                e.returnValue = '您有未保存的数据，确定要离开吗？';
                return e.returnValue;
            }
        };
    </script>
</body>
</html>
