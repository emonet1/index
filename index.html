<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>眼动追踪数据收集系统 - 视频观看版</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB6O5l6uZa-6sywCZTGRJx2CKPuq3KeBF0",
            authDomain: "index-9f58d.firebaseapp.com",
            projectId: "index-9f58d",
            storageBucket: "index-9f58d.appspot.com",
            messagingSenderId: "718279245978",
            appId: "1:718279245978:web:93a9a07473ad8d3e6a5f23"
        };
        
        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // 生成唯一用户ID
        const generateUniqueUserId = () => {
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substr(2, 9);
            return `user_${timestamp}_${randomStr}`;
        };
        
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const userId = generateUniqueUserId(); // 每个用户都有唯一ID
        console.log('会话ID:', sessionId);
        console.log('用户ID:', userId);

        // 动态加载WebGazer
        async function loadWebGazerScript() {
            const sources = [
                'https://webgazer.cs.brown.edu/webgazer.js',
                'https://unpkg.com/webgazer@2.0.2/dist/webgazer.js',
                'https://cdn.jsdelivr.net/npm/webgazer@2.0.2/dist/webgazer.min.js'
            ];
            for (const source of sources) {
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = source;
                        script.onload = resolve;
                        script.onerror = () => reject(new Error(`无法从 ${source} 加载WebGazer`));
                        script.timeout = 10000;
                        document.head.appendChild(script);
                    });
                    console.log(`WebGazer从 ${source} 加载成功`);
                    return true;
                } catch (error) {
                    console.error(`加载失败: ${error.message}`);
                }
            }
            return false;
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- 引入JSZip和FileSaver库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: #f0f0f0; }
        #heatmapContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; visibility: hidden; }
        #plotting_canvas { position: fixed; top: 0; left: 0; cursor: crosshair; z-index: 900; pointer-events: none; }
        #content { position: relative; z-index: 1; padding: 30px; max-width: 800px; margin: 10px auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #statsPanel { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: rgba(0,0,0,0.85); 
            color: white; 
            padding: 10px 15px; 
            border-radius: 10px; 
            z-index: 2000; 
            width: 200px; 
            font-size: 11px;
        }
        .stat-item { 
            margin: 8px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .stat-value { 
            font-weight: bold; 
            color: #4CAF50; 
            font-size: 10px;
        }
        #debugPanel { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.9); color: #00ff00; padding: 15px; border-radius: 8px; z-index: 2000; max-width: 350px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; display: none; }
        .controls { text-align: center; margin: 20px 0; }
        .btn { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 0 10px; font-size: 16px; transition: background 0.3s; }
        .btn:hover { background: #45a049; }
        .btn.danger { background: #f44336; }
        .btn.danger:hover { background: #da190b; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn.test { background: #2196F3; }
        .btn.test:hover { background: #1976D2; }
        .btn.toggle { background: #FF9800; }
        .btn.toggle:hover { background: #F57C00; }
        .status { position: fixed; top: 20px; left: 20px; padding: 10px 15px; border-radius: 20px; font-weight: bold; z-index: 2000; }
        .status.ready { background: #4CAF50; color: white; }
        .status.calibrating { background: #ff9800; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.initializing { background: #2196F3; color: white; }
        .status.loading { background: #9C27B0; color: white; }
        
        #webgazerVideoContainer {
            display: block !important; 
            position: fixed !important;
            top: 0px !important;
            left: 0px !important;
            width: 320px !important;
            height: 240px !important;
            z-index: 1;
        }
        
        .Calibration {
            width: 20px;
            height: 20px;
            border-radius: 25px;
            background-color: red;
            opacity: 0.2;
            border: 1px solid black;
            position:fixed;
            z-index: 100000;
        }
        #Pt1{ top: 70px; left:340px; }
        #Pt2{ top: 70px; left:50vw; margin-left: 340; }
        #Pt3{ top: 70px; right:2vw; }
        #Pt4{ top:50vh; left:2vw; }
        #Pt5{ top: 50vh; left: 50vw; }
        #Pt6{ top: 50vh; right:2vw; }
        #Pt7{ bottom:2vw; left: 2vw; }
        #Pt8{ bottom:2vw; left:50vw; }
        #Pt9{ bottom:2vw; right:2vw; }

        #Accuracy { background-color: #222; color: white; padding: 8px; border-radius: 5px; text-align: center; font-size: 11px; margin: 8px 0; }
        .collection-status { margin-top: 10px; padding: 8px; border-radius: 5px; text-align: center; font-size: 10px; }
        .collection-status.connected { background: #4CAF50; color: white; }
        .collection-status.disconnected { background: #f44336; color: white; }
        .collection-status.uploading { background: #ff9800; color: white; }
        .firebase-status { margin-top: 8px; padding: 8px; border-radius: 4px; text-align: center; font-size: 10px; }
        .heatmap-visible { visibility: visible !important; }
        
        #videoInfoOverlay {
            position: fixed; 
            top: 10px;
            left: 10px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            z-index: 10000; 
            pointer-events: none;
            visibility: hidden;
            border: 2px solid white;
        }
        
        .video-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        /* 弹窗输入框样式 */
        .swal-content__input {
            display: block;
            width: 90%;
            margin: 10px auto;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div id="status" class="status loading">正在加载库文件...</div>
    <canvas id="plotting_canvas" width="500" height="500"></canvas>

    <div id="statsPanel">
        <h4 style="margin: 0 0 8px 0; text-align: center; color: #4CAF50; font-size: 13px;">📊 眼动数据统计</h4>
        <div class="stat-item"><span>学号:</span><span id="studentIdDisplay" class="stat-value">N/A</span></div>
        <div class="stat-item"><span>姓名:</span><span id="studentNameDisplay" class="stat-value">N/A</span></div>
        <div class="stat-item"><span>用户ID:</span><span id="userIdDisplay" class="stat-value" style="font-size: 9px; word-break: break-all;"></span></div>
        <div class="stat-item"><span>会话ID:</span><span id="sessionIdDisplay" class="stat-value" style="font-size: 9px; word-break: break-all;"></span></div>
        <div class="stat-item"><span>注视点总数:</span><span id="totalGazes" class="stat-value">0</span></div>
        <div class="stat-item"><span>眼跳次数:</span><span id="saccadeCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>注视次数:</span><span id="fixationCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>平均注视时间:</span><span id="avgFixationTime" class="stat-value">0ms</span></div>
        <div class="stat-item"><span>热力图快照:</span><span id="heatmapSnapshots" class="stat-value">0</span></div>
        <div class="stat-item"><span>数据快照数:</span><span id="snapshotCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>运行时间:</span><span id="runningTime" class="stat-value">0s</span></div>
        <div id="Accuracy">等待校准...</div>
        <div class="stat-item"><span>系统状态:</span><span id="systemStatus" class="stat-value">加载中</span></div>
        <div class="collection-status disconnected" id="collectionStatus">📈 数据收集: 未开始</div>
        <div class="firebase-status disconnected" id="firebaseStatus">🔥 Firebase: 未连接</div>
        <button class="btn test" onclick="testFirebaseConnection()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">🧪 测试连接</button>
        <button class="btn test" onclick="forceSaveData()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">💾 强制保存</button>
        <button class="btn toggle" onclick="toggleHeatmap()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">🔥 显示/隐藏热力图</button>
        <button class="btn test" onclick="testVideoCapture()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">📹 测试视频截图</button>
        <button class="btn test" onclick="toggleDebug()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">🐛 显示调试</button>
        <button class="btn test" onclick="testOverlayVisibility()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">👁️ 测试覆盖层</button>
        <button class="btn test" onclick="testDataCollection()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">📊 测试数据收集</button>
        <button class="btn test" onclick="testFullscreenCapture()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">🎬 测试全屏截图</button>
    </div>

    <div id="debugPanel"><div id="debugInfo">调试信息将在这里显示...</div></div>
    <div id="heatmapContainer"></div>
    
    <div class="calibrationDiv">
        <input type="button" class="Calibration" id="Pt1">
        <input type="button" class="Calibration" id="Pt2">
        <input type="button" class="Calibration" id="Pt3">
        <input type="button" class="Calibration" id="Pt4">
        <input type="button" class="Calibration" id="Pt5">
        <input type="button" class="Calibration" id="Pt6">
        <input type="button" class="Calibration" id="Pt7">
        <input type="button" class="Calibration" id="Pt8">
        <input type="button" class="Calibration" id="Pt9">
    </div>

    <div id="content">
        <div class="controls">
            <button class="btn" id="startBtn" onclick="startEyeTracking()" disabled>🚀 启动眼动追踪</button>
            <button class="btn" id="calibrateBtn" onclick="PopUpInstruction()" disabled>🎯 开始校准</button>
            <button class="btn" onclick="Restart()">🔄 重新校准</button>
            <button class="btn" onclick="exportData()">📊 导出数据</button>
        </div>

        <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f2f2f2; border-radius: 8px;">
            <div class="video-container">
                <video 
                    id="eyeTrackingVideoPlayer" 
                    src="https://res.cloudinary.com/ddp3tohxk/video/upload/v1757416692/%E9%99%A4%E8%9E%A8%E4%BB%AA_bzhlgy.mp4" 
                    width="100%" 
                    crossorigin="anonymous"
                    preload="auto"
                    style="border-radius: 8px; background: #000; max-height: 400px;"
                ></video>
                <div id="videoInfoOverlay">
                    用户: <span id="overlayUserId"></span> | 时间: <span id="overlayTimestamp">0.00s</span>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn" id="playVideoBtn" onclick="startVideoExperiment()" style="font-size: 18px; padding: 15px 30px;">▶️ 开始视频实验</button>
                <!-- 下载热力图压缩包的按钮，默认隐藏 -->
                <button class="btn test" id="downloadHeatmapZipBtn" onclick="generateAndDownloadHeatmapZip()" style="display: none; margin-top: 15px;">💾 生成并下载热力图压缩包</button>
            </div>
        </div>

    </div>

    <script>
        // ===========================================
        // 全局变量定义
        // ===========================================
        let heatmapInstance = null, gazeCount = 0, snapshotCount = 0, heatmapSnapshotCount = 0, saccadeCount = 0, fixationCount = 0, totalFixationTime = 0;
        let startTime = Date.now();
        let isTracking = false, webgazerReady = false, debugMode = false, librariesLoaded = false, firebaseConnected = false;
        let isCalibrating = false, isVideoExperimentActive = false;
        
        let studentId = null;
        let studentName = null;
        
        var PointCalibrate = 0;
        var CalibrationPoints = {};
        
        let eyeTrackingData = { gazePoints: [], saccades: [], fixations: [], heatmapSnapshots: [], calibrationData: { points: [], accuracyPercentage: null, timestamp: null } };

        let persistentHeatmapData = [];
        let allTimeGazePoints = [];

        let lastGazePoint = null, currentFixation = null;
        const fixationThreshold = 50, fixationTimeThreshold = 100;

        let autoSaveInterval = null, heatmapSnapshotInterval = null, statsUpdateInterval = null;

        document.getElementById('sessionIdDisplay').textContent = sessionId;
        document.getElementById('userIdDisplay').textContent = userId;
        
        document.getElementById('overlayUserId').textContent = userId;
        
        // ===========================================
        // 收集学生信息的功能
        // ===========================================
        async function collectStudentInfo() {
            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = `
                <p style="text-align: left; font-weight: bold;">请输入您的学号和姓名开始实验:</p>
                <input id="swal-student-id" class="swal-content__input" placeholder="学号 (Student ID)">
                <input id="swal-student-name" class="swal-content__input" placeholder="姓名 (Name)">
            `;

            swal({
                title: "身份信息",
                content: contentDiv,
                buttons: {
                    confirm: {
                        text: "提交",
                        value: true,
                        visible: true,
                        className: "",
                        closeModal: false,
                    },
                },
                closeOnClickOutside: false,
                closeOnEsc: false,
            }).then(async () => {
                const idInput = document.getElementById('swal-student-id').value.trim();
                const nameInput = document.getElementById('swal-student-name').value.trim();

                if (!idInput || !nameInput) {
                    swal("错误!", "学号和姓名不能为空!", "error");
                    setTimeout(collectStudentInfo, 1500);
                    return;
                }

                studentId = idInput;
                studentName = nameInput;

                document.getElementById('studentIdDisplay').textContent = studentId;
                document.getElementById('studentNameDisplay').textContent = studentName;

                swal.stopLoading();
                swal.close();

                await saveStudentInfoToFirebase();
                await initializeSystem();
            });
        }
        
        async function saveStudentInfoToFirebase() {
            debug(`正在保存学生信息: ${studentId} - ${studentName}`);
            try {
                await db.collection("student_info_video_v1").add({
                    studentId,
                    studentName,
                    userId,
                    sessionId,
                    timestamp: new Date().toISOString(),
                    experimentType: 'video_eye_tracking'
                });
                debug('学生信息成功保存到Firebase。');
                swal('信息已记录', `学号: ${studentId}\n姓名: ${studentName}`, 'success', { timer: 2000 });
            } catch (error) {
                console.error("保存学生信息失败: ", error);
                debug(`保存学生信息失败: ${error.message}`);
                swal('保存失败', '无法记录您的信息，请检查网络连接并刷新页面。', 'error');
            }
        }
        
        // ===========================================
        // 核心系统函数
        // ===========================================
        function debug(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[DEBUG ${timestamp}] ${message}`);
            if (debugMode) {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.innerHTML = `[${timestamp}] ${message}<br>` + debugDiv.innerHTML.split('<br>').slice(0, 30).join('<br>');
            }
        }
        function updateStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            document.getElementById('systemStatus').textContent = message;
            debug(`状态更新: ${message}`);
        }
        function updateFirebaseStatus(message, status) {
            const el = document.getElementById('firebaseStatus');
            el.textContent = `🔥 Firebase: ${message}`;
            el.className = `firebase-status ${status}`;
        }
        function updateCollectionStatus(message, status) {
            const el = document.getElementById('collectionStatus');
            el.textContent = `📈 数据收集: ${message}`;
            el.className = `collection-status ${status}`;
        }
        
        async function testFirebaseConnection() {
            debug('开始测试Firebase连接...');
            updateFirebaseStatus('测试中...', 'uploading');
            try {
                await db.collection("video_experiment_connection_test_v1").add({ 
                    sessionId, 
                    userId, 
                    studentId,
                    studentName,
                    timestamp: new Date().toISOString(),
                    experimentType: 'video_eye_tracking'
                });
                debug('Firebase连接测试成功！');
                updateFirebaseStatus('连接正常', 'connected');
                firebaseConnected = true;
                swal('成功', `Firebase连接测试成功！\n用户ID: ${userId}`, 'success');
            } catch (error) {
                console.error("Firebase Connection Test Failed: ", error);
                debug(`Firebase连接测试失败: ${error.message}`);
                updateFirebaseStatus('连接失败', 'disconnected');
                firebaseConnected = false;
                swal('失败', `Firebase连接测试失败！\n\n${error.message}`, 'error');
            }
        }
        async function forceSaveData() {
            if (!isTracking) return swal('提示', '请先启动眼动追踪。', 'info');
            await saveEyeTrackingData(true);
        }
        
        // ===========================================
        // 视频处理逻辑
        // ===========================================
        function setupVideoPlayer() {
            const videoPlayer = document.getElementById('eyeTrackingVideoPlayer');
            
            videoPlayer.controls = false;
            videoPlayer.controlsList = "nodownload nofullscreen noremoteplayback";
            videoPlayer.disablePictureInPicture = true;
            
            videoPlayer.addEventListener('loadedmetadata', () => debug(`视频元数据加载完成: ${videoPlayer.videoWidth}x${videoPlayer.videoHeight}`));
            videoPlayer.addEventListener('canplay', () => debug('视频可以开始播放'));
            videoPlayer.addEventListener('error', (e) => debug(`视频加载错误: ${e.message}`));
            
            videoPlayer.onplay = () => {
                debug(`视频开始播放，当前时间: ${videoPlayer.currentTime.toFixed(2)}s`);
                isVideoExperimentActive = true;
                startVideoInfoUpdate();
            };
            
            videoPlayer.onpause = () => {
                debug(`视频已暂停，当前时间: ${videoPlayer.currentTime.toFixed(2)}s`);
                isVideoExperimentActive = false;
                stopVideoInfoUpdate();
            };

            videoPlayer.onended = () => {
                debug('视频播放结束');
                isVideoExperimentActive = false;
                stopVideoInfoUpdate();
                exitFullscreen();
                
                swal('实验结束', '视频播放已结束！现在您可以生成并下载包含所有热力图图片的压缩包。', 'success');
                const downloadBtn = document.getElementById('downloadHeatmapZipBtn');
                downloadBtn.style.display = 'inline-block';
            };

            videoPlayer.addEventListener('seeking', (e) => { if (isVideoExperimentActive) e.preventDefault(); });
            videoPlayer.addEventListener('contextmenu', (e) => e.preventDefault());

            debug("视频播放器已准备就绪。");
        }
        
        let videoInfoInterval = null;
        function startVideoInfoUpdate() { if (videoInfoInterval) clearInterval(videoInfoInterval); videoInfoInterval = setInterval(updateVideoInfo, 100); }
        function stopVideoInfoUpdate() { if (videoInfoInterval) { clearInterval(videoInfoInterval); videoInfoInterval = null; } }

        function updateVideoInfo() {
            const videoPlayer = document.getElementById('eyeTrackingVideoPlayer');
            const timestampElement = document.getElementById('overlayTimestamp');
            if (videoPlayer && timestampElement) {
                timestampElement.textContent = videoPlayer.currentTime.toFixed(2) + 's';
            }
        }

        async function startVideoExperiment() {
            if (!isTracking || !webgazerReady) return swal('提示', '请先启动并校准眼动追踪系统！', 'warning');
            const videoPlayer = document.getElementById('eyeTrackingVideoPlayer');
            const playBtn = document.getElementById('playVideoBtn');
            try {
                videoPlayer.currentTime = 0;
                await videoPlayer.play();
                setTimeout(() => enterFullscreen(videoPlayer).catch(err => debug(`全屏失败: ${err.message}`)), 100);
                playBtn.textContent = '🎬 实验进行中...';
                playBtn.disabled = true;
                isVideoExperimentActive = true;
            } catch (error) {
                debug(`启动视频实验失败: ${error.message}`);
                swal('错误', '无法启动视频实验，请检查浏览器权限！', 'error');
            }
        }

        async function enterFullscreen(element) {
            if (element.requestFullscreen) await element.requestFullscreen();
            else if (element.webkitRequestFullscreen) await element.webkitRequestFullscreen();
            else if (element.msRequestFullscreen) await element.msRequestFullscreen();
            debug('已进入全屏模式');
            setTimeout(updateHeatmapForFullscreen, 500);
        }

        function updateHeatmapForFullscreen() {
            if (heatmapInstance) {
                debug(`更新热力图配置为全屏尺寸: ${window.innerWidth}x${window.innerHeight}`);
                const heatmapContainer = document.getElementById('heatmapContainer');
                heatmapContainer.style.width = window.innerWidth + 'px';
                heatmapContainer.style.height = window.innerHeight + 'px';
                heatmapInstance = h337.create({ container: heatmapContainer, radius: Math.max(25, window.innerWidth / 50), maxOpacity: 0.7, minOpacity: 0.1, blur: 0.8 });
            }
        }

        function exitFullscreen() {
            try {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
                const playBtn = document.getElementById('playVideoBtn');
                playBtn.textContent = '▶️ 开始视频实验';
                playBtn.disabled = false;
                debug('已退出全屏模式');
            } catch (error) {
                debug(`退出全屏失败: ${error.message}`);
            }
        }
        
        // ... (其他测试函数保持不变) ...
        function testVideoCapture() { /* ... */ }
        function testOverlayVisibility() { /* ... */ }
        function testDataCollection() { /* ... */ }
        function testFullscreenCapture() { /* ... */ }
        
        // ===========================================
        // 眼动数据处理
        // ===========================================
        function gazeDataCallback(data, elapsedTime) {
            if (isCalibrating || !data || typeof data.x !== 'number' || typeof data.y !== 'number' || isNaN(data.x) || isNaN(data.y) || data.x < 0 || data.y < 0 || !isTracking) return;
            const timestamp = new Date().toISOString();
            const videoPlayer = document.getElementById('eyeTrackingVideoPlayer');
            const isFullscreen = !!document.fullscreenElement;
            let gazePoint = { 
                x: Math.floor(data.x), y: Math.floor(data.y), timestamp, 
                elapsedTime: elapsedTime || Date.now() - startTime, sessionId, userId,
                videoTimestamp: null, relativeX: null, relativeY: null,
                isVideoActive: isVideoExperimentActive, isFullscreen: isFullscreen
            };
            if (videoPlayer && !videoPlayer.paused && videoPlayer.currentTime > 0 && isVideoExperimentActive) {
                gazePoint.videoTimestamp = parseFloat(videoPlayer.currentTime.toFixed(4));
                if (isFullscreen) {
                    gazePoint.relativeX = gazePoint.x;
                    gazePoint.relativeY = gazePoint.y;
                } else {
                    const videoRect = videoPlayer.getBoundingClientRect();
                    const relX = gazePoint.x - videoRect.left;
                    const relY = gazePoint.y - videoRect.top;
                    if (relX >= 0 && relX <= videoRect.width && relY >= 0 && relY <= videoRect.height) {
                        gazePoint.relativeX = Math.floor(relX);
                        gazePoint.relativeY = Math.floor(relY);
                    }
                }
            }
            processSaccadeAndFixation(gazePoint);
            eyeTrackingData.gazePoints.push(gazePoint);
            allTimeGazePoints.push({ x: gazePoint.x, y: gazePoint.y, timestamp: gazePoint.timestamp, videoTimestamp: gazePoint.videoTimestamp, isVideoActive: gazePoint.isVideoActive });
            if (heatmapInstance) heatmapInstance.addData({ x: gazePoint.x, y: gazePoint.y, value: 5 });
            gazeCount++;
            if (gazeCount % 50 === 0) updateStatsDisplay();
        }

        function processSaccadeAndFixation(gazePoint) { /* ... (此函数保持不变) ... */ }
        function updateStatsDisplay() { /* ... (此函数保持不变) ... */ }
        function startHeatmapSnapshots() { if (heatmapSnapshotInterval) clearInterval(heatmapSnapshotInterval); heatmapSnapshotInterval = setInterval(() => { if (heatmapInstance && isTracking && allTimeGazePoints.length > 0) captureHeatmapSnapshot(); }, 2000); }
        function stopHeatmapSnapshots() { if (heatmapSnapshotInterval) clearInterval(heatmapSnapshotInterval); }
        async function captureHeatmapSnapshot() { /* ... (此函数保持不变) ... */ }

        // ===========================================
        // **核心修改**：生成并下载包含真实图片的热力图压缩包
        // ===========================================
        async function generateAndDownloadHeatmapZip() {
            const btn = document.getElementById('downloadHeatmapZipBtn');
            btn.textContent = '🔄 正在准备...';
            btn.disabled = true;
            swal('处理中', '正在打包数据并下载热力图图片，这可能需要一些时间...', 'info', { buttons: false });

            try {
                debug("开始生成包含图片的热力图数据压缩包...");
                const zip = new JSZip();

                // 1. 添加原始数据CSV文件
                if (allTimeGazePoints.length > 0) {
                    let csvContent = "timestamp,x,y,videoTimestamp,isVideoActive\n";
                    allTimeGazePoints.forEach(p => {
                        csvContent += `${p.timestamp},${p.x},${p.y},${p.videoTimestamp || 'N/A'},${p.isVideoActive}\n`;
                    });
                    zip.file("raw_gaze_points.csv", csvContent);
                    debug(`已添加 ${allTimeGazePoints.length} 个原始注视点数据到CSV。`);
                }

                // 2. 添加热力图快照信息JSON文件
                const snapshotsInfo = {
                    studentId, studentName, userId, sessionId,
                    totalSnapshots: eyeTrackingData.heatmapSnapshots.length,
                    snapshots: eyeTrackingData.heatmapSnapshots
                };
                zip.file("heatmap_snapshots_info.json", JSON.stringify(snapshotsInfo, null, 2));

                // 3. **从Cloudinary下载所有热力图图片并添加到ZIP中**
                if (eyeTrackingData.heatmapSnapshots.length > 0) {
                    const imageFolder = zip.folder("heatmap_images");
                    debug(`准备下载 ${eyeTrackingData.heatmapSnapshots.length} 张热力图图片...`);
                    
                    const downloadPromises = eyeTrackingData.heatmapSnapshots.map(snapshot =>
                        fetch(snapshot.storageUrl)
                            .then(response => {
                                if (!response.ok) throw new Error(`下载失败: ${snapshot.fileName}`);
                                return response.blob();
                            })
                            .then(blob => {
                                // 使用 .png 后缀确保文件类型正确
                                const fileNameWithExt = snapshot.fileName.endsWith('.png') ? snapshot.fileName : `${snapshot.fileName}.png`;
                                imageFolder.file(fileNameWithExt, blob);
                                debug(`已成功下载并添加图片到ZIP: ${fileNameWithExt}`);
                            })
                            .catch(error => {
                                debug(`下载图片 ${snapshot.fileName} 时出错: ${error.message}`);
                            })
                    );
                    
                    // 等待所有图片下载完成
                    await Promise.all(downloadPromises);
                    debug("所有热力图图片已下载并添加到压缩包。");
                }
                
                // 4. 生成ZIP文件并触发下载
                btn.textContent = '🔄 正在压缩...';
                const content = await zip.generateAsync({ type: "blob" });
                const zipFileName = `Heatmap_Data_${studentId}_${sessionId}.zip`;
                
                saveAs(content, zipFileName);
                
                debug(`压缩包生成成功: ${zipFileName}`);
                swal.close();
                swal('成功！', '您的热力图数据压缩包（包含所有图片）已开始下载。', 'success');

            } catch (error) {
                console.error("生成ZIP压缩包失败: ", error);
                debug(`生成ZIP压缩包失败: ${error.message}`);
                swal('失败！', `无法生成压缩包，请查看控制台错误信息。\n\n${error.message}`, 'error');
            } finally {
                btn.textContent = '💾 生成并下载热力图压缩包';
                btn.disabled = false;
            }
        }


        function startAutoSave() { if (autoSaveInterval) clearInterval(autoSaveInterval); autoSaveInterval = setInterval(() => saveEyeTrackingData(false), 5000); updateCollectionStatus('进行中 (自动)', 'connected'); }
        function stopAutoSave() { if (autoSaveInterval) clearInterval(autoSaveInterval); }
        async function saveEyeTrackingData(isManual = false) { /* ... (此函数保持不变) ... */ }
        
        // =======================================================================
        // 校准与精度测试流程 (保持不变)
        // =======================================================================
        function ClearCanvas(){ /* ... */ }
        function PopUpInstruction() { /* ... */ }
        function ShowCalibrationPoint() { /* ... */ }
        function calPointClick(node) { /* ... */ }
        function calcAccuracy() { /* ... */ }
        function sleep(time) { return new Promise((resolve) => setTimeout(resolve, time)); }
        function calculatePrecision(past50Array) { /* ... */ };
        function Restart() { /* ... */ }
        function ClearCalibration() { /* ... */ }

        // =======================================================================
        // 系统控制与生命周期 (保持不变)
        // =======================================================================
        function toggleDebug() { debugMode = !debugMode; document.getElementById('debugPanel').style.display = debugMode ? 'block' : 'none'; }
        function toggleHeatmap() { const hc = document.getElementById('heatmapContainer'); hc.classList.toggle('heatmap-visible'); hc.style.visibility = hc.classList.contains('heatmap-visible') ? 'visible' : 'hidden'; }
        function startStatsUpdate() { if (statsUpdateInterval) clearInterval(statsUpdateInterval); statsUpdateInterval = setInterval(() => { if (isTracking) { document.getElementById('runningTime').textContent = Math.round((Date.now() - startTime) / 1000) + 's'; updateStatsDisplay(); } }, 1000); }
        function stopStatsUpdate() { if (statsUpdateInterval) clearInterval(statsUpdateInterval); }
        function exportData() { /* ... */ }

        async function initializeSystem() {
            try {
                if (typeof h337 === 'undefined' || typeof swal === 'undefined' || typeof JSZip === 'undefined') throw new Error('依赖库加载失败');
                if (!await loadWebGazerScript() || typeof webgazer === 'undefined') throw new Error('WebGazer加载失败');
                heatmapInstance = h337.create({ container: document.getElementById('heatmapContainer'), radius: 25, maxOpacity: 0.6, minOpacity: 0.1, blur: 0.8 });
                await testFirebaseConnection();
                updateStatus('系统就绪', 'ready');
                document.getElementById('startBtn').disabled = false;
                librariesLoaded = true;
                ClearCanvas();
                setupVideoPlayer();
            } catch (error) {
                updateStatus('初始化失败', 'error');
                swal('严重错误', `系统初始化失败:\n\n${error.message}`, 'error');
            }
        }

        async function startEyeTracking() {
            if (!librariesLoaded) return;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            updateStatus('初始化WebGazer...', 'initializing');
            try {
                await webgazer.setRegression('ridge').setTracker('clmtrackr').setGazeListener(gazeDataCallback).begin();
                webgazer.showVideoPreview(true).showPredictionPoints(true).applyKalmanFilter(true);
                isTracking = true; startTime = Date.now(); webgazerReady = true;
                if (firebaseConnected) startAutoSave();
                startHeatmapSnapshots(); startStatsUpdate();
                updateStatus('运行中', 'ready');
                document.getElementById('calibrateBtn').disabled = false;
                startBtn.textContent = '✅ 运行中';
                swal('启动成功', '眼动追踪已启动！\n强烈建议您点击“开始校准”以提高精度。', 'success');
            } catch (error) {
                console.error("启动眼动追踪失败:", error);
                updateStatus('启动失败', 'error');
                startBtn.disabled = false;
                swal('启动失败', `无法启动眼动追踪。\n请检查摄像头权限。\n\n${error.message}`, 'error');
            }
        }

        async function performStop() {
            if (firebaseConnected) await saveEyeTrackingData(true);
            isTracking = false;
            stopAutoSave(); stopHeatmapSnapshots(); stopStatsUpdate();
            if (typeof webgazer !== 'undefined' && webgazer.isReady()) webgazer.end();
            ClearCalibration(); ClearCanvas();
            updateStatus('已停止', 'error');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = '🚀 启动眼动追踪';
            document.getElementById('calibrateBtn').disabled = true;
        }

        window.addEventListener('load', collectStudentInfo);
        window.addEventListener('error', (e) => debug(`全局错误: ${e.message}`));
        window.addEventListener('unhandledrejection', (e) => debug(`Promise拒绝: ${e.reason}`));
        window.addEventListener('beforeunload', (e) => { if (isTracking && eyeTrackingData.gazePoints.length > 0) { const msg = '您有未保存的数据，确定要离开吗？'; e.returnValue = msg; return msg; } });
        document.addEventListener('visibilitychange', () => { if (isTracking && webgazer) { document.visibilityState === 'hidden' ? webgazer.pause() : webgazer.resume(); } });
    </script>
</body>
</html>
