<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>眼动追踪数据收集系统 - 官方校准版</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB6O5l6uZa-6sywCZTGRJx2CKPuq3KeBF0",
            authDomain: "index-9f58d.firebaseapp.com",
            projectId: "index-9f58d",
            storageBucket: "index-9f58d.appspot.com",
            messagingSenderId: "718279245978",
            appId: "1:718279245978:web:93a9a07473ad8d3e6a5f23"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const userId = 'index';
        console.log('会话ID:', sessionId);
        console.log('用户ID:', userId);

        async function loadWebGazerScript() {
            const source = 'https://webgazer.cs.brown.edu/webgazer.js';
            try {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = source;
                    script.onload = resolve;
                    script.onerror = () => reject(new Error(`无法从 ${source} 加载WebGazer`));
                    script.timeout = 10000;
                    document.head.appendChild(script);
                });
                console.log(`WebGazer从 ${source} 加载成功`);
                return true;
            } catch (error) {
                console.error(`加载失败: ${error.message}`);
                return false;
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: #f0f0f0; }
        #heatmapContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1000; opacity: 0.7; visibility: hidden; }
        #content { position: relative; z-index: 1; padding: 50px; max-width: 800px; margin: 20px auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #statsPanel { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.85); color: white; padding: 10px 15px; border-radius: 10px; z-index: 2000; width: 280px; font-size: 12px; }
        .stat-item { margin: 8px 0; display: flex; justify-content: space-between; }
        .stat-value { font-weight: bold; color: #4CAF50; }
        #debugPanel { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.9); color: #00ff00; padding: 15px; border-radius: 8px; z-index: 2000; max-width: 350px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; display: none; }
        .test-area { height: 150px; margin: 30px 0; padding: 20px; border-radius: 10px; border: 2px solid #ddd; cursor: pointer; }
        .area-blue { background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; }
        .area-green { background: linear-gradient(135deg, #00b894, #00a085); color: white; }
        .area-orange { background: linear-gradient(135deg, #fdcb6e, #e17055); color: white; }
        .controls { text-align: center; margin: 30px 0; }
        .btn { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 0 10px; font-size: 16px; transition: background 0.3s; }
        .btn:hover { background: #45a049; }
        .btn.danger { background: #f44336; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status { position: fixed; top: 20px; left: 20px; padding: 10px 15px; border-radius: 20px; font-weight: bold; z-index: 2000; }
        .status.ready { background: #4CAF50; color: white; }
        .status.calibrating { background: #ff9800; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.initializing { background: #2196F3; color: white; }
        .status.loading { background: #9C27B0; color: white; }
        /* 【修改】与官方示例一致的校准点样式 */
        .Calibration { background-color: red; border: solid; border-color: white; border-width: 3px; border-radius: 100%; width: 25px; height: 25px; position: fixed; z-index: 10000; opacity: 0.2; cursor: pointer;}
        #Pt1 { top: 5%; left: 5%; } #Pt2 { top: 5%; left: 50%; transform: translateX(-50%);} #Pt3 { top: 5%; right: 5%; }
        #Pt4 { top: 50%; left: 5%; transform: translateY(-50%);} #Pt5 { top: 50%; left: 50%; transform: translate(-50%, -50%);} #Pt6 { top: 50%; right: 5%; transform: translateY(-50%);}
        #Pt7 { bottom: 5%; left: 5%; } #Pt8 { bottom: 5%; left: 50%; transform: translateX(-50%);} #Pt9 { bottom: 5%; right: 5%; }
        #Accuracy { background-color: #222; color: white; padding: 8px; border-radius: 5px; text-align: center; }
        .collection-status { margin-top: 10px; padding: 8px; border-radius: 5px; text-align: center; }
        .collection-status.connected { background: #4CAF50; color: white; } .collection-status.disconnected { background: #f44336; color: white; } .collection-status.uploading { background: #ff9800; color: white; }
        .firebase-status { margin-top: 8px; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px; }
        .heatmap-visible { opacity: 0.7 !important; visibility: visible !important; }
    </style>
</head>
<body>
    <div id="status" class="status loading">正在加载库文件...</div>

    <div id="statsPanel">
        <h4 style="margin: 0 0 10px 0; text-align: center; color: #4CAF50;">📊 眼动数据统计</h4>
        <div class="stat-item"><span>会话ID:</span><span id="sessionIdDisplay" class="stat-value" style="font-size: 10px; word-break: break-all;"></span></div>
        <div class="stat-item"><span>注视点总数:</span><span id="totalGazes" class="stat-value">0</span></div>
        <div class="stat-item"><span>眼跳次数:</span><span id="saccadeCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>注视次数:</span><span id="fixationCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>平均注视时间:</span><span id="avgFixationTime" class="stat-value">0ms</span></div>
        <div class="stat-item"><span>热力图快照:</span><span id="heatmapSnapshots" class="stat-value">0</span></div>
        <div class="stat-item"><span>数据快照数:</span><span id="snapshotCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>运行时间:</span><span id="runningTime" class="stat-value">0s</span></div>
        <div id="Accuracy">等待校准...</div>
        <div class="stat-item"><span>系统状态:</span><span id="systemStatus" class="stat-value">加载中</span></div>
        <div class="collection-status disconnected" id="collectionStatus">📈 数据收集: 未开始</div>
        <div class="firebase-status disconnected" id="firebaseStatus">🔥 Firebase: 未连接</div>
        <button class="btn test" onclick="testFirebaseConnection()" style="width: 100%; margin: 8px 0 0 0; padding: 6px; font-size: 12px;">🧪 测试连接</button>
        <button class="btn test" onclick="forceSaveData()" style="width: 100%; margin-top: 5px; padding: 6px; font-size: 12px;">💾 强制保存</button>
        <button class="btn toggle" onclick="toggleHeatmap()" style="width: 100%; margin-top: 5px; padding: 6px; font-size: 12px;">🔥 显示热力图</button>
        <button class="btn test" onclick="toggleDebug()" style="width: 100%; margin-top: 5px; padding: 6px; font-size: 12px;">🐛 显示调试</button>
    </div>

    <div id="debugPanel"><div id="debugInfo">调试信息将在这里显示...</div></div>
    <div id="heatmapContainer"></div>
    
    <!-- 【修改】校准点HTML与官方示例一致 -->
    <div class="calibrationDiv">
        <input type="button" class="Calibration" id="Pt1" style="display: none;">
        <input type="button" class="Calibration" id="Pt2" style="display: none;">
        <input type="button" class="Calibration" id="Pt3" style="display: none;">
        <input type="button" class="Calibration" id="Pt4" style="display: none;">
        <input type="button" class="Calibration" id="Pt5" style="display: none;">
        <input type="button" class="Calibration" id="Pt6" style="display: none;">
        <input type="button" class="Calibration" id="Pt7" style="display: none;">
        <input type="button" class="Calibration" id="Pt8" style="display: none;">
        <input type="button" class="Calibration" id="Pt9" style="display: none;">
    </div>

    <div id="content">
        <h1 style="text-align: center; color: #333;">👁️ 眼动追踪数据收集系统 - 官方校准版</h1>
        <div class="controls">
            <button class="btn" id="startBtn" onclick="startEyeTracking()" disabled>🚀 启动眼动追踪</button>
            <!-- 【修改】两个校准按钮都指向新的Restart函数 -->
            <button class="btn" id="calibrateBtn" onclick="Restart()" disabled>🎯 开始校准</button>
            <button class="btn" onclick="Restart()">🔄 重新校准</button>
            <button class="btn" onclick="exportData()">📊 导出数据</button>
            <button class="btn danger" onclick="stopTracking()">⏹️ 停止追踪</button>
        </div>
        <p style="text-align: center; font-size: 18px; color: #666; margin: 30px 0;">👀 请自然地浏览下面的内容，系统会完整收集您的眼动数据</p>
        <div class="test-area area-blue" onclick="debug('点击了蓝色区域')"><h2>🌊 区域 A - 海洋蓝</h2><p>这是第一个测试区域。请尝试注视这里几秒钟，系统会记录您的注视点坐标、注视时间和眼动模式。</p></div>
        <div class="test-area area-green" onclick="debug('点击了绿色区域')"><h2>🌿 区域 B - 森林绿</h2><p>这是第二个测试区域。在不同区域之间移动视线会产生眼跳数据，包括移动距离和速度。</p></div>
        <div class="test-area area-orange" onclick="debug('点击了橙色区域')"><h2>🔥 区域 C - 夕阳橙</h2><p>这是第三个测试区域。长时间注视会生成注视数据。系统每隔几秒会将生成的热力图快照上传到云端存储。</p></div>
    </div>

    <script>
        // ===========================================
        // 全局变量 (部分为新校准逻辑所需)
        // ===========================================
        let heatmapInstance = null, gazeCount = 0, snapshotCount = 0, heatmapSnapshotCount = 0, saccadeCount = 0, fixationCount = 0, totalFixationTime = 0;
        let startTime = Date.now();
        let isTracking = false, webgazerReady = false, debugMode = false, heatmapVisible = false, librariesLoaded = false, firebaseConnected = false;
        
        // 【新增】官方校准逻辑所需的变量
        var PointCalibrate = 0;
        var CalibrationPoints = {};
        var precision_measurement; // 用于精度测量的定时器

        let eyeTrackingData = { gazePoints: [], saccades: [], fixations: [], heatmapSnapshots: [], calibrationData: { points: [], accuracy: null, timestamp: null } };
        let lastGazePoint = null, currentFixation = null;
        const fixationThreshold = 50, fixationTimeThreshold = 100;
        let autoSaveInterval = null, heatmapSnapshotInterval = null, statsUpdateInterval = null;

        document.getElementById('sessionIdDisplay').textContent = sessionId;

        // ... (debug, updateStatus, firebase, collectionStatus 函数保持不变，为简洁省略) ...
        function debug(message) { const ts=new Date().toLocaleTimeString();console.log(`[DEBUG ${ts}] ${message}`);if(debugMode){const d=document.getElementById('debugInfo');d.innerHTML=`[${ts}] ${message}<br>`+d.innerHTML.split('<br>').slice(0,30).join('<br>')}}
        function updateStatus(message,type){const s=document.getElementById('status');s.textContent=message;s.className=`status ${type}`;document.getElementById('systemStatus').textContent=message;debug(`状态更新: ${message}`)}
        function updateFirebaseStatus(message,status){const e=document.getElementById('firebaseStatus');e.textContent=`🔥 Firebase: ${message}`;e.className=`firebase-status ${status}`}
        function updateCollectionStatus(message,status){const e=document.getElementById('collectionStatus');e.textContent=`📈 数据收集: ${message}`;e.className=`collection-status ${status}`}
        async function testFirebaseConnection(){debug('开始测试Firebase连接...');updateFirebaseStatus('测试中...','uploading');try{await db.collection("connection_test").add({sessionId,userId,timestamp:new Date().toISOString()});debug('Firebase连接测试成功！');updateFirebaseStatus('连接正常','connected');firebaseConnected=true;swal('成功','Firebase连接测试成功！','success')}catch(error){console.error("Firebase Connection Test Failed: ",error);debug(`Firebase连接测试失败: ${error.message}`);updateFirebaseStatus('连接失败','disconnected');firebaseConnected=false;swal('失败',`Firebase连接测试失败！\n\n${error.message}`,'error')}}
        async function forceSaveData(){if(!isTracking)return swal('提示','请先启动眼动追踪。','info');await saveEyeTrackingData(true)}


        // =============================================================
        // 【核心替换】官方校准逻辑 (已与您的应用整合)
        // =============================================================
        
        /**
         * 清除校准状态并重置UI
         */
        function ClearCalibration() {
            document.querySelectorAll('.Calibration').forEach(el => {
                el.style.backgroundColor = 'red';
                el.style.opacity = '0.2';
                el.disabled = false;
                el.style.display = 'none'; // 隐藏所有点
            });
            CalibrationPoints = {};
            PointCalibrate = 0;
        }

        /**
         * 弹出校准说明，并在用户确认后开始
         */
        function PopUpInstruction() {
            ClearCalibration();
            updateStatus('校准准备中', 'calibrating');
            swal({
                title: "校准",
                text: "请点击屏幕上出现的9个点。每个点需要点击5次。点击后，请注视该点直到它变黄，然后再次点击。完成5次点击后，该点会消失。",
                buttons: {
                    cancel: "取消",
                    confirm: "我准备好了"
                }
            }).then(isConfirm => {
                if (isConfirm) {
                    document.querySelectorAll('.Calibration').forEach(el => el.style.display = 'block'); // 显示所有点
                    updateStatus('校准进行中', 'calibrating');
                } else {
                    updateStatus('运行中', 'ready'); // 用户取消
                }
            });
        }

        /**
         * 重新开始校准流程 (这是校准按钮的统一入口)
         */
        function Restart() {
            if (!isTracking) {
                swal("提示", "请先启动眼动追踪。", "info");
                return;
            }
            document.getElementById('Accuracy').textContent = "等待校准...";
            if (webgazer) webgazer.clearData();
            PopUpInstruction();
        }

        /**
         * 在9点校准完成后，独立测量精度
         */
        function measurePrecision() {
            let precision_data = [];
            let precision_counter = 0;
            let precision_storing = false;

            if (precision_measurement) clearInterval(precision_measurement); // 清除旧的定时器

            swal({
                title: "正在计算精度",
                text: "请不要移动鼠标，并注视屏幕中央5秒钟。",
                closeOnEsc: false,
                allowOutsideClick: false,
                closeModal: true
            }).then(() => {
                precision_measurement = setInterval(() => {
                    if (!precision_storing) {
                        precision_storing = true;
                        webgazer.pause();
                        setTimeout(() => {
                            const prediction = webgazer.getCurrentPrediction();
                            if (prediction) {
                                precision_data.push({ x: prediction.x, y: prediction.y });
                            }
                            webgazer.resume();
                            precision_storing = false;
                            precision_counter++;

                            if (precision_counter >= 5) { // 5秒后
                                clearInterval(precision_measurement);
                                const avg_x = precision_data.map(d => d.x).reduce((a, b) => a + b, 0) / precision_data.length;
                                const avg_y = precision_data.map(d => d.y).reduce((a, b) => a + b, 0) / precision_data.length;
                                const center_x = window.innerWidth / 2;
                                const center_y = window.innerHeight / 2;
                                const dx = avg_x - center_x;
                                const dy = avg_y - center_y;
                                const distance = Math.sqrt(dx * dx + dy * dy);
                                const accuracyStr = `${Math.round(distance)}px`;

                                document.getElementById('Accuracy').textContent = `精度: ${accuracyStr}`;
                                eyeTrackingData.calibrationData = { points: CalibrationPoints, accuracy: accuracyStr, timestamp: new Date().toISOString() };
                                updateStatus(`校准完成 - 精度: ${accuracyStr}`, 'ready');
                                swal("校准完成!", `您的预测精度约为 ${accuracyStr}`, "success");
                            }
                        }, 100);
                    }
                }, 1000); // 每秒测量一次
            });
        }

        // ===========================================
        // 眼动数据处理 (保持不变)
        // ===========================================
        function gazeDataCallback(data, elapsedTime) {
            if (!isTracking || !data || data.x == null || data.y == null) return;
            const gazePoint = { x: Math.round(data.x), y: Math.round(data.y), timestamp: new Date().toISOString(), elapsedTime, sessionId, userId };
            processSaccadeAndFixation(gazePoint);
            eyeTrackingData.gazePoints.push(gazePoint);
            if (heatmapInstance) heatmapInstance.addData({ x: gazePoint.x, y: gazePoint.y, value: 5 });
            gazeCount++;
        }
        function processSaccadeAndFixation(gazePoint) {
            if (!lastGazePoint) {
                lastGazePoint = gazePoint;
                currentFixation = { startPoint: {...gazePoint}, startTime: gazePoint.timestamp, pointCount: 1, sessionId, userId };
                return;
            }
            const distance = Math.sqrt(Math.pow(gazePoint.x - lastGazePoint.x, 2) + Math.pow(gazePoint.y - lastGazePoint.y, 2));
            if (distance > fixationThreshold) {
                if (currentFixation && currentFixation.pointCount > 1) {
                    const duration = new Date(gazePoint.timestamp).getTime() - new Date(currentFixation.startTime).getTime();
                    if (duration > fixationTimeThreshold) {
                        currentFixation.duration = duration;
                        currentFixation.endPoint = {...lastGazePoint};
                        currentFixation.centerPoint = { x: Math.round((currentFixation.startPoint.x + currentFixation.endPoint.x) / 2), y: Math.round((currentFixation.startPoint.y + currentFixation.endPoint.y) / 2) };
                        eyeTrackingData.fixations.push({...currentFixation});
                        fixationCount++;
                        totalFixationTime += duration;
                    }
                }
                const saccadeDuration = new Date(gazePoint.timestamp).getTime() - new Date(lastGazePoint.timestamp).getTime();
                eyeTrackingData.saccades.push({ startPoint: {...lastGazePoint}, endPoint: {...gazePoint}, distance: Math.round(distance), duration: saccadeDuration, velocity: saccadeDuration > 0 ? Math.round(distance / saccadeDuration * 1000) : 0, sessionId, userId });
                saccadeCount++;
                currentFixation = { startPoint: {...gazePoint}, startTime: gazePoint.timestamp, pointCount: 1, sessionId, userId };
            } else {
                if (currentFixation) currentFixation.pointCount++;
            }
            lastGazePoint = gazePoint;
        }

        // ===========================================
        // 系统核心功能
        // ===========================================
        
        async function initializeSystem() {
            try {
                if (typeof h337 === 'undefined' || typeof swal === 'undefined') throw new Error('依赖库加载失败');
                if (!await loadWebGazerScript() || typeof webgazer === 'undefined') throw new Error('WebGazer加载失败');
                heatmapInstance = h337.create({ container: document.getElementById('heatmapContainer'), radius: 25, maxOpacity: 0.6, minOpacity: 0.1, blur: 0.8 });
                await testFirebaseConnection();
                updateStatus('系统就绪', 'ready');
                document.getElementById('startBtn').disabled = false;
                librariesLoaded = true;

                // 【新增】为校准点绑定一次性的点击事件监听器
                document.querySelectorAll('.Calibration').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.id;
                        if (!CalibrationPoints[id]) CalibrationPoints[id] = 0;
                        CalibrationPoints[id]++;

                        if (CalibrationPoints[id] == 5) {
                            button.style.backgroundColor = 'yellow';
                            button.disabled = true;
                            PointCalibrate++;
                        } else if (CalibrationPoints[id] < 5) {
                            button.style.opacity = (0.2 * CalibrationPoints[id] + 0.2).toString();
                        }

                        if (PointCalibrate >= 9) {
                            document.querySelectorAll('.Calibration').forEach(el => el.style.display = 'none');
                            measurePrecision(); // 所有点完成后开始测量精度
                        }
                    });
                });
            } catch (error) {
                updateStatus('初始化失败', 'error');
                swal('严重错误', `系统初始化失败:\n\n${error.message}`, 'error');
            }
        }
        
        /**
         * 【新增】用于全局点击监听的命名函数，方便移除
         */
        function recordClickEvent(event) {
            if (webgazer && webgazer.isReady()) {
                webgazer.recordScreenPosition(event.clientX, event.clientY, 'click');
            }
        }

        async function startEyeTracking() {
            if (!librariesLoaded) return;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            updateStatus('初始化WebGazer...', 'initializing');
            try {
                await webgazer.setGazeListener(gazeDataCallback).begin();
                webgazer.showVideoPreview(true).showPredictionPoints(true).applyKalmanFilter(true);
                
                webgazerReady = true; isTracking = true; startTime = Date.now();
                if (firebaseConnected) startAutoSave();
                startHeatmapSnapshots();
                startStatsUpdate();
                
                // 【新增】启动时添加全局点击监听器以训练模型
                document.body.addEventListener('click', recordClickEvent);

                updateStatus('运行中', 'ready');
                document.getElementById('calibrateBtn').disabled = false;
                startBtn.textContent = '✅ 运行中';
                swal('启动成功', '眼动追踪已启动！请进行校准以提高精度。', 'success');
            } catch (error) {
                updateStatus('启动失败', 'error');
                startBtn.disabled = false;
                swal('启动失败', `无法启动眼动追踪。\n请检查摄像头权限。\n\n${error.message}`, 'error');
            }
        }

        function stopTracking() {
            if (!isTracking) return;
            swal({ title: "确认停止", text: "确定要停止追踪吗？所有未保存的数据将尝试最后一次上传。", icon: "warning", buttons: true, dangerMode: true, })
            .then((willStop) => { if (willStop) performStop(); });
        }

        /**
         * 【修改】确保可靠地停止追踪并关闭摄像头
         */
        async function performStop() {
            if (firebaseConnected) await saveEyeTrackingData(true);
            isTracking = false;
            
            if (typeof webgazer !== 'undefined' && webgazer.isReady()) {
                try {
                    // 【新增】移除全局点击监听器，停止训练
                    document.body.removeEventListener('click', recordClickEvent);
                    // 【修改】使用 await 确保异步操作完成
                    await webgazer.end();
                    debug("WebGazer已停止，摄像头已关闭。");
                } catch (e) {
                    console.error("停止WebGazer时出错: ", e);
                }
            }

            if (precision_measurement) clearInterval(precision_measurement);
            stopAutoSave();
            stopHeatmapSnapshots();
            stopStatsUpdate();
            ClearCalibration();

            updateStatus('已停止', 'error');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = '🚀 启动眼动追踪';
            document.getElementById('calibrateBtn').disabled = true;
            swal('已停止', `眼动追踪已停止，摄像头已关闭。`, 'success');
        }

        window.addEventListener('load', initializeSystem);
        window.addEventListener('error', (e) => debug(`全局错误: ${e.message}`));
        window.addEventListener('unhandledrejection', (e) => debug(`Promise拒绝: ${e.reason}`));
        window.addEventListener('beforeunload', (e) => {
            if (isTracking && eyeTrackingData.gazePoints.length > 0) {
                const message = '您有未保存的数据，确定要离开吗？'; e.returnValue = message; return message;
            }
        });
        document.addEventListener('visibilitychange', () => {
            if (isTracking && webgazer) { document.visibilityState === 'hidden' ? webgazer.pause() : webgazer.resume(); }
        });
        
        // --- 保持不变的辅助函数 ---
        function updateStatsDisplay(){document.getElementById('totalGazes').textContent=gazeCount;document.getElementById('saccadeCount').textContent=saccadeCount;document.getElementById('fixationCount').textContent=fixationCount;document.getElementById('heatmapSnapshots').textContent=heatmapSnapshotCount;document.getElementById('snapshotCount').textContent=snapshotCount;document.getElementById('avgFixationTime').textContent=(fixationCount>0?Math.round(totalFixationTime/fixationCount):0)+'ms'}
        function startHeatmapSnapshots(){if(heatmapSnapshotInterval)clearInterval(heatmapSnapshotInterval);heatmapSnapshotInterval=setInterval(()=>{if(heatmapInstance&&isTracking)captureHeatmapSnapshot()},2000)}
        function stopHeatmapSnapshots(){if(heatmapSnapshotInterval)clearInterval(heatmapSnapshotInterval)}
        async function captureHeatmapSnapshot(){try{const canvas=document.getElementById('heatmapContainer').querySelector('canvas');if(!canvas){debug('无法捕获热力图快照：Canvas未找到。');return}heatmapInstance.repaint();setTimeout(async()=>{try{const imageDataUrl=canvas.toDataURL('image/png',0.8);const cloudName='ddp3tohxk';const uploadPreset='index1';const url=`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;const formData=new FormData();formData.append('file',imageDataUrl);formData.append('upload_preset',uploadPreset);formData.append('folder',`heatmaps/${userId}/${sessionId}`);debug(`开始上传热力图到 Cloudinary...`);const response=await fetch(url,{method:'POST',body:formData});if(!response.ok){const errorData=await response.json();throw new Error(`Cloudinary上传失败: ${errorData.error.message}`)}const data=await response.json();const secureUrl=data.secure_url;debug(`热力图上传成功: ${secureUrl}`);eyeTrackingData.heatmapSnapshots.push({timestamp:new Date().toISOString(),storageUrl:secureUrl,provider:'cloudinary',sessionId,userId});heatmapSnapshotCount++;updateStatsDisplay()}catch(e){console.error("热力图上传或快照失败: ",e);debug(`热力图上传或快照失败: ${e.message}`)}},150)}catch(error){console.error("捕获热力图快照时出错: ",error);debug(`捕获热力图快照时出错: ${error.message}`)}}
        function startAutoSave(){if(autoSaveInterval)clearInterval(autoSaveInterval);autoSaveInterval=setInterval(()=>saveEyeTrackingData(false),10000);updateCollectionStatus('进行中 (自动)','connected')}
        function stopAutoSave(){if(autoSaveInterval)clearInterval(autoSaveInterval)}
        async function saveEyeTrackingData(isManual=false){if(!firebaseConnected){if(isManual)swal('错误','Firebase未连接，无法保存。','error');return}const totalPoints=eyeTrackingData.gazePoints.length+eyeTrackingData.saccades.length+eyeTrackingData.fixations.length+eyeTrackingData.heatmapSnapshots.length;if(totalPoints===0){if(isManual)swal('提示','没有新数据可保存。','info');return}const dataToSave=JSON.parse(JSON.stringify(eyeTrackingData));const payload={sessionId,userId,timestamp:new Date().toISOString(),dataType:isManual?'manual':'auto',gazeData:dataToSave.gazePoints,saccadeData:dataToSave.saccades,fixationData:dataToSave.fixations,heatmapData:dataToSave.heatmapSnapshots,calibrationInfo:dataToSave.calibrationData};eyeTrackingData.gazePoints=[];eyeTrackingData.saccades=[];eyeTrackingData.fixations=[];eyeTrackingData.heatmapSnapshots=[];updateCollectionStatus('保存中...','uploading');try{await db.collection("eye_tracking_comprehensive_v3_storage").add(payload);snapshotCount++;updateCollectionStatus('进行中 (自动)','connected');debug(`数据快照 #${snapshotCount} 保存成功`);if(isManual)swal('成功',`数据已保存！`,'success')}catch(error){console.error("Firebase 保存失败: ",error);debug(`数据保存失败: ${error.message}, 正在恢复数据...`);updateCollectionStatus('保存失败','disconnected');if(isManual)swal('失败',`数据保存失败！\n\n${error.message}`,'error');eyeTrackingData.gazePoints=dataToSave.gazePoints.concat(eyeTrackingData.gazePoints);eyeTrackingData.saccades=dataToSave.saccades.concat(eyeTrackingData.saccades);eyeTrackingData.fixations=dataToSave.fixations.concat(eyeTrackingData.fixations);eyeTrackingData.heatmapSnapshots=dataToSave.heatmapSnapshots.concat(eyeTrackingData.heatmapSnapshots)}}
        function toggleDebug(){debugMode=!debugMode;document.getElementById('debugPanel').style.display=debugMode?'block':'none'}
        function toggleHeatmap(){heatmapVisible=!heatmapVisible;document.getElementById('heatmapContainer').classList.toggle('heatmap-visible')}
        function startStatsUpdate(){if(statsUpdateInterval)clearInterval(statsUpdateInterval);statsUpdateInterval=setInterval(()=>{if(isTracking){document.getElementById('runningTime').textContent=Math.round((Date.now()-startTime)/1000)+'s';updateStatsDisplay()}},1000)}
        function stopStatsUpdate(){if(statsUpdateInterval)clearInterval(statsUpdateInterval)}
        function exportData(){if(gazeCount===0)return swal('无数据','没有可导出的数据。','warning');const dataStr=JSON.stringify({sessionInfo:{sessionId,userId},collectedData:eyeTrackingData},null,2);const link=document.createElement('a');link.href=URL.createObjectURL(new Blob([dataStr],{type:'application/json'}));link.download=`eye-tracking-data-${sessionId}.json`;link.click();URL.revokeObjectURL(link.href)}
    </script>
</body>
</html>
