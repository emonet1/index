<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>眼动追踪数据收集系统 - 视频观看版</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB6O5l6uZa-6sywCZTGRJx2CKPuq3KeBF0",
            authDomain: "index-9f58d.firebaseapp.com",
            projectId: "index-9f58d",
            storageBucket: "index-9f58d.appspot.com",
            messagingSenderId: "718279245978",
            appId: "1:718279245978:web:93a9a07473ad8d3e6a5f23"
        };
        
        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // 生成唯一用户ID
        const generateUniqueUserId = () => {
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substr(2, 9);
            return `user_${timestamp}_${randomStr}`;
        };
        
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const userId = generateUniqueUserId(); // 每个用户都有唯一ID
        console.log('会话ID:', sessionId);
        console.log('用户ID:', userId);

        // 动态加载WebGazer
        async function loadWebGazerScript() {
            const sources = [
                'https://webgazer.cs.brown.edu/webgazer.js',
                'https://unpkg.com/webgazer@2.0.2/dist/webgazer.js',
                'https://cdn.jsdelivr.net/npm/webgazer@2.0.2/dist/webgazer.min.js'
            ];
            for (const source of sources) {
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = source;
                        script.onload = resolve;
                        script.onerror = () => reject(new Error(`无法从 ${source} 加载WebGazer`));
                        script.timeout = 10000;
                        document.head.appendChild(script);
                    });
                    console.log(`WebGazer从 ${source} 加载成功`);
                    return true;
                } catch (error) {
                    console.error(`加载失败: ${error.message}`);
                }
            }
            return false;
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: #f0f0f0; }
        #heatmapContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; visibility: hidden; }
        #plotting_canvas { position: fixed; top: 0; left: 0; cursor: crosshair; z-index: 900; pointer-events: none; }
        #content { position: relative; z-index: 1; padding: 30px; max-width: 800px; margin: 10px auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #statsPanel { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: rgba(0,0,0,0.85); 
            color: white; 
            padding: 10px 15px; 
            border-radius: 10px; 
            z-index: 2000; 
            width: 200px; 
            font-size: 11px;
        }
        .stat-item { 
            margin: 8px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .stat-value { 
            font-weight: bold; 
            color: #4CAF50; 
            font-size: 10px;
        }
        #debugPanel { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.9); color: #00ff00; padding: 15px; border-radius: 8px; z-index: 2000; max-width: 350px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; display: none; }
        .controls { text-align: center; margin: 20px 0; }
        .btn { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 0 10px; font-size: 16px; transition: background 0.3s; }
        .btn:hover { background: #45a049; }
        .btn.danger { background: #f44336; }
        .btn.danger:hover { background: #da190b; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn.test { background: #2196F3; }
        .btn.test:hover { background: #1976D2; }
        .btn.toggle { background: #FF9800; }
        .btn.toggle:hover { background: #F57C00; }
        .status { position: fixed; top: 20px; left: 20px; padding: 10px 15px; border-radius: 20px; font-weight: bold; z-index: 2000; }
        .status.ready { background: #4CAF50; color: white; }
        .status.calibrating { background: #ff9800; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.initializing { background: #2196F3; color: white; }
        .status.loading { background: #9C27B0; color: white; }
        
        #webgazerVideoContainer {
            display: block !important; 
            position: fixed !important;
            top: 0px !important;
            left: 0px !important;
            width: 320px !important;
            height: 240px !important;
            z-index: 1;
        }
        
        .Calibration {
            width: 20px;
            height: 20px;
            border-radius: 25px;
            background-color: red;
            opacity: 0.2;
            border: 1px solid black;
            position:fixed;
            z-index: 100000;
        }
        #Pt1{ top: 70px; left:340px; }
        #Pt2{ top: 70px; left:50vw; margin-left: 340; }
        #Pt3{ top: 70px; right:2vw; }
        #Pt4{ top:50vh; left:2vw; }
        #Pt5{ top: 50vh; left: 50vw; }
        #Pt6{ top: 50vh; right:2vw; }
        #Pt7{ bottom:2vw; left: 2vw; }
        #Pt8{ bottom:2vw; left:50vw; }
        #Pt9{ bottom:2vw; right:2vw; }

        #Accuracy { background-color: #222; color: white; padding: 8px; border-radius: 5px; text-align: center; font-size: 11px; margin: 8px 0; }
        .collection-status { margin-top: 10px; padding: 8px; border-radius: 5px; text-align: center; font-size: 10px; }
        .collection-status.connected { background: #4CAF50; color: white; }
        .collection-status.disconnected { background: #f44336; color: white; }
        .collection-status.uploading { background: #ff9800; color: white; }
        .firebase-status { margin-top: 8px; padding: 8px; border-radius: 4px; text-align: center; font-size: 10px; }
        .heatmap-visible { visibility: visible !important; }
        
        /* 视频时间戳覆盖层 - 仅在热力图截图时可见 */
        #videoInfoOverlay {
            position: fixed; /* 改为 fixed 以确保在全屏时可见 */
            top: 10px;
            left: 10px;
            background: rgba(255, 0, 0, 0.9); /* 改为红色背景便于调试 */
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            z-index: 10000; /* 提高 z-index 确保在全屏时可见 */
            pointer-events: none;
            visibility: hidden; /* 默认隐藏，用户看不到 */
            border: 2px solid white; /* 添加白色边框便于识别 */
        }
        
        /* 全屏时的视频容器 */
        .video-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="status" class="status loading">正在加载库文件...</div>
    <canvas id="plotting_canvas" width="500" height="500"></canvas>

    <div id="statsPanel">
        <h4 style="margin: 0 0 8px 0; text-align: center; color: #4CAF50; font-size: 13px;">📊 眼动数据统计</h4>
        <div class="stat-item"><span>用户ID:</span><span id="userIdDisplay" class="stat-value" style="font-size: 9px; word-break: break-all;"></span></div>
        <div class="stat-item"><span>会话ID:</span><span id="sessionIdDisplay" class="stat-value" style="font-size: 9px; word-break: break-all;"></span></div>
        <div class="stat-item"><span>注视点总数:</span><span id="totalGazes" class="stat-value">0</span></div>
        <div class="stat-item"><span>眼跳次数:</span><span id="saccadeCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>注视次数:</span><span id="fixationCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>平均注视时间:</span><span id="avgFixationTime" class="stat-value">0ms</span></div>
        <div class="stat-item"><span>热力图快照:</span><span id="heatmapSnapshots" class="stat-value">0</span></div>
        <div class="stat-item"><span>数据快照数:</span><span id="snapshotCount" class="stat-value">0</span></div>
        <div class="stat-item"><span>运行时间:</span><span id="runningTime" class="stat-value">0s</span></div>
        <div id="Accuracy">等待校准...</div>
        <div class="stat-item"><span>系统状态:</span><span id="systemStatus" class="stat-value">加载中</span></div>
        <div class="collection-status disconnected" id="collectionStatus">📈 数据收集: 未开始</div>
        <div class="firebase-status disconnected" id="firebaseStatus">🔥 Firebase: 未连接</div>
        <button class="btn test" onclick="testFirebaseConnection()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">🧪 测试连接</button>
        <button class="btn test" onclick="forceSaveData()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">💾 强制保存</button>
        <button class="btn toggle" onclick="toggleHeatmap()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">🔥 显示/隐藏热力图</button>
        <button class="btn test" onclick="testVideoCapture()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">📹 测试视频截图</button>
        <button class="btn test" onclick="toggleDebug()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">🐛 显示调试</button>
        <button class="btn test" onclick="testOverlayVisibility()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">👁️ 测试覆盖层</button>
        <button class="btn test" onclick="testDataCollection()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">📊 测试数据收集</button>
        <button class="btn test" onclick="testFullscreenCapture()" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 10px;">🎬 测试全屏截图</button>
    </div>

    <div id="debugPanel"><div id="debugInfo">调试信息将在这里显示...</div></div>
    <div id="heatmapContainer"></div>
    
    <div class="calibrationDiv">
        <input type="button" class="Calibration" id="Pt1">
        <input type="button" class="Calibration" id="Pt2">
        <input type="button" class="Calibration" id="Pt3">
        <input type="button" class="Calibration" id="Pt4">
        <input type="button" class="Calibration" id="Pt5">
        <input type="button" class="Calibration" id="Pt6">
        <input type="button" class="Calibration" id="Pt7">
        <input type="button" class="Calibration" id="Pt8">
        <input type="button" class="Calibration" id="Pt9">
    </div>

    <div id="content">
        <div class="controls">
            <button class="btn" id="startBtn" onclick="startEyeTracking()" disabled>🚀 启动眼动追踪</button>
            <button class="btn" id="calibrateBtn" onclick="PopUpInstruction()" disabled>🎯 开始校准</button>
            <button class="btn" onclick="Restart()">🔄 重新校准</button>
            <button class="btn" onclick="exportData()">📊 导出数据</button>
        </div>

        <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f2f2f2; border-radius: 8px;">
            <div class="video-container">
                <video 
                    id="eyeTrackingVideoPlayer" 
                    src="https://res.cloudinary.com/ddp3tohxk/video/upload/v1757416692/%E9%99%A4%E8%9E%A8%E4%BB%AA_bzhlgy.mp4" 
                    width="100%" 
                    crossorigin="anonymous"
                    preload="auto"
                    style="border-radius: 8px; background: #000; max-height: 400px;"
                ></video>
                <div id="videoInfoOverlay">
                    用户: <span id="overlayUserId"></span> | 时间: <span id="overlayTimestamp">0.00s</span>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn" id="playVideoBtn" onclick="startVideoExperiment()" style="font-size: 18px; padding: 15px 30px;">▶️ 开始视频实验</button>
            </div>
        </div>

    </div>

    <script>
        // ===========================================
        // 全局变量定义
        // ===========================================
        let heatmapInstance = null, gazeCount = 0, snapshotCount = 0, heatmapSnapshotCount = 0, saccadeCount = 0, fixationCount = 0, totalFixationTime = 0;
        let startTime = Date.now();
        let isTracking = false, webgazerReady = false, debugMode = false, librariesLoaded = false, firebaseConnected = false;
        let isCalibrating = false, isVideoExperimentActive = false;
        
        var PointCalibrate = 0;
        var CalibrationPoints = {};
        
        let eyeTrackingData = { gazePoints: [], saccades: [], fixations: [], heatmapSnapshots: [], calibrationData: { points: [], accuracyPercentage: null, timestamp: null } };

        let lastGazePoint = null, currentFixation = null;
        const fixationThreshold = 50, fixationTimeThreshold = 100;

        let autoSaveInterval = null, heatmapSnapshotInterval = null, statsUpdateInterval = null;

        // 新增：注视点过滤和平滑处理
        let gazeBuffer = [];
        const GAZE_BUFFER_SIZE = 5;
        const OUTLIER_THRESHOLD = 200; // 像素距离阈值
        let lastValidGaze = null;

        document.getElementById('sessionIdDisplay').textContent = sessionId;
        document.getElementById('userIdDisplay').textContent = userId;
        
        // 初始化视频信息覆盖层
        document.getElementById('overlayUserId').textContent = userId;
        
        // ===========================================
        // 核心系统函数
        // ===========================================
        function debug(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[DEBUG ${timestamp}] ${message}`);
            if (debugMode) {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.innerHTML = `[${timestamp}] ${message}<br>` + debugDiv.innerHTML.split('<br>').slice(0, 30).join('<br>');
            }
        }

        // 新增：注视点验证和过滤函数
        function isValidGazePoint(gazePoint) {
            // 基本边界检查
            if (!gazePoint || typeof gazePoint.x !== 'number' || typeof gazePoint.y !== 'number') {
                return false;
            }
            
            // 检查是否在屏幕边界内
            if (gazePoint.x < 0 || gazePoint.x > window.innerWidth || 
                gazePoint.y < 0 || gazePoint.y > window.innerHeight) {
                return false;
            }
            
            // 检查是否为异常值（与上一个有效点距离过远）
            if (lastValidGaze) {
                const distance = Math.sqrt(
                    Math.pow(gazePoint.x - lastValidGaze.x, 2) + 
                    Math.pow(gazePoint.y - lastValidGaze.y, 2)
                );
                if (distance > OUTLIER_THRESHOLD) {
                    debug(`过滤异常注视点: 距离=${distance.toFixed(2)}px`);
                    return false;
                }
            }
            
            return true;
        }

        // 新增：注视点平滑处理
        function smoothGazePoint(rawGaze) {
            if (!isValidGazePoint(rawGaze)) {
                return null;
            }

            // 添加到缓冲区
            gazeBuffer.push(rawGaze);
            if (gazeBuffer.length > GAZE_BUFFER_SIZE) {
                gazeBuffer.shift();
            }

            // 如果缓冲区未满，返回原始点
            if (gazeBuffer.length < 3) {
                lastValidGaze = rawGaze;
                return rawGaze;
            }

            // 计算加权平均（最新的点权重更高）
            let totalWeight = 0;
            let weightedX = 0;
            let weightedY = 0;

            gazeBuffer.forEach((point, index) => {
                const weight = index + 1; // 权重从1到GAZE_BUFFER_SIZE
                weightedX += point.x * weight;
                weightedY += point.y * weight;
                totalWeight += weight;
            });

            const smoothedGaze = {
                x: Math.round(weightedX / totalWeight),
                y: Math.round(weightedY / totalWeight)
            };

            lastValidGaze = smoothedGaze;
            return smoothedGaze;
        }

        // ...existing code...

        // ===========================================
        // 眼动数据处理 - 重写gazeDataCallback函数
        // ===========================================
        function gazeDataCallback(data, elapsedTime) {
            // 如果正在校准或未启动跟踪，则不记录数据
            if (!isTracking || isCalibrating) return;
            
            // 只有在视频实验激活时才记录数据
            if (!isVideoExperimentActive) {
                return;
            }

            // 验证和平滑处理注视点数据
            const smoothedGaze = smoothGazePoint(data);
            if (!smoothedGaze) {
                return; // 跳过无效的注视点
            }
            
            const timestamp = new Date().toISOString();
            const videoPlayer = document.getElementById('eyeTrackingVideoPlayer');
            const isFullscreen = document.fullscreenElement !== null || 
                               document.webkitFullscreenElement !== null || 
                               document.mozFullScreenElement !== null ||
                               document.msFullscreenElement !== null;

            let gazePoint = { 
                x: smoothedGaze.x, 
                y: smoothedGaze.y, 
                timestamp, 
                elapsedTime: elapsedTime || Date.now() - startTime, 
                sessionId, 
                userId,
                videoTimestamp: null,
                relativeX: null,
                relativeY: null,
                isVideoActive: isVideoExperimentActive,
                isFullscreen: isFullscreen,
                isSmoothed: true // 标记为已平滑处理
            };

            // 检查视频是否正在播放，以关联眼动数据和视频时间戳
            if (videoPlayer && !videoPlayer.paused && videoPlayer.currentTime > 0 && isVideoExperimentActive) {
                gazePoint.videoTimestamp = parseFloat(videoPlayer.currentTime.toFixed(4));
                
                if (isFullscreen) {
                    // 全屏模式：眼动坐标直接对应屏幕坐标
                    gazePoint.relativeX = gazePoint.x;
                    gazePoint.relativeY = gazePoint.y;
                } else {
                    // 窗口模式：计算相对于视频播放器的坐标
                    const videoRect = videoPlayer.getBoundingClientRect();
                    const relX = gazePoint.x - videoRect.left;
                    const relY = gazePoint.y - videoRect.top;

                    if (relX >= 0 && relX <= videoRect.width && relY >= 0 && relY <= videoRect.height) {
                        gazePoint.relativeX = Math.floor(relX);
                        gazePoint.relativeY = Math.floor(relY);
                    }
                }
                
                // 只在每100个点时输出一次调试信息
                if (gazeCount % 100 === 0) {
                    debug(`记录注视点: x=${gazePoint.x}, y=${gazePoint.y}, 视频时间=${gazePoint.videoTimestamp}s, 全屏=${isFullscreen}`);
                }
            }

            processSaccadeAndFixation(gazePoint);
            eyeTrackingData.gazePoints.push(gazePoint);
            
            // 修复热力图数据添加 - 确保坐标正确
            if (heatmapInstance) {
                // 根据当前模式调整热力图坐标
                let heatmapX = gazePoint.x;
                let heatmapY = gazePoint.y;
                
                // 在全屏模式下，直接使用屏幕坐标
                if (isFullscreen) {
                    heatmapX = gazePoint.x;
                    heatmapY = gazePoint.y;
                } else {
                    // 窗口模式下，使用相对坐标（如果在视频区域内）
                    if (gazePoint.relativeX !== null && gazePoint.relativeY !== null) {
                        const videoRect = videoPlayer.getBoundingClientRect();
                        heatmapX = videoRect.left + gazePoint.relativeX;
                        heatmapY = videoRect.top + gazePoint.relativeY;
                    }
                }
                
                heatmapInstance.addData({ 
                    x: Math.round(heatmapX), 
                    y: Math.round(heatmapY), 
                    value: 5 
                });
            }
            
            gazeCount++;
            if (gazeCount % 50 === 0) {
                updateStatsDisplay();
                debug(`已记录 ${gazeCount} 个注视点（已平滑处理）`);
            }
        }

        // ...existing code...

        async function startEyeTracking() {
            if (!librariesLoaded) return;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            updateStatus('初始化WebGazer...', 'initializing');
            try {
                // 修复WebGazer初始化配置
                await webgazer
                    .setRegression('ridge') // 使用ridge回归，更稳定
                    .setTracker('clmtrackr') // 使用clmtrackr追踪器
                    .setGazeListener(gazeDataCallback)
                    .begin();

                // 等待WebGazer完全准备就绪
                await new Promise((resolve) => {
                    const checkReady = () => {
                        if (webgazer.isReady()) {
                            resolve();
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    checkReady();
                });

                // 配置WebGazer参数以提高精度
                webgazer.showVideoPreview(true)
                        .showPredictionPoints(true)
                        .applyKalmanFilter(true); // 启用卡尔曼滤波器

                // 设置更严格的参数
                if (webgazer.params) {
                    webgazer.params.imgWidth = 320;
                    webgazer.params.imgHeight = 240;
                    webgazer.params.faceFinder = true;
                }

                // 重置数据缓冲区
                gazeBuffer = [];
                lastValidGaze = null;
                
                isTracking = true; 
                startTime = Date.now(); 
                webgazerReady = true;
                
                if (firebaseConnected) startAutoSave();
                startHeatmapSnapshots(); 
                startStatsUpdate();
                updateStatus('运行中', 'ready');
                document.getElementById('calibrateBtn').disabled = false;
                startBtn.textContent = '✅ 运行中';
                
                debug('WebGazer初始化完成，添加了注视点过滤和平滑处理');
                swal('启动成功', '眼动追踪已启动！\n已启用数据过滤和平滑处理。\n强烈建议您点击"开始校准"以提高精度。', 'success');
            } catch (error) {
                console.error("启动眼动追踪失败:", error);
                updateStatus('启动失败', 'error');
                startBtn.disabled = false;
                swal('启动失败', `无法启动眼动追踪。\n请检查摄像头权限。\n\n${error.message}`, 'error');
            }
        }

        // 修复校准流程 - 添加更多校准点以提高精度
        function PopUpInstruction() {
            if (!isTracking) return swal('提示', '请先启动眼动追踪。', 'info');
            
            // 设置校准状态标志
            isCalibrating = true;
            
            // 清除之前的数据缓冲区
            gazeBuffer = [];
            lastValidGaze = null;
            
            document.getElementById('statsPanel').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';
            ClearCanvas();
            swal({
                title:"校准说明",
                text: "请点击屏幕上出现的9个点。您必须在每个点上点击5次，直到它变成黄色。请保持头部稳定，仔细注视每个点。校准质量直接影响热力图准确性。",
                buttons:{ cancel: false, confirm: "开始" }
            }).then(() => {
                updateStatus('校准进行中', 'calibrating');
                debug('开始9点校准流程，已清除数据缓冲区');
                ShowCalibrationPoint();
                document.querySelectorAll('.Calibration').forEach((i) => { i.onclick = () => calPointClick(i); });
            });
        }

        function calcAccuracy() {
            swal({
                title: "正在计算精度",
                text: "请不要移动您的鼠标和头部，并尽力注视屏幕中央的点10秒钟。这将帮助我们计算预测的准确性。",
                closeOnEsc: false, allowOutsideClick: false, closeModal: true
            }).then(() => {
                updateStatus('精度测试中...', 'calibrating');
                if (webgazer) webgazer.params.storingPoints = true;
                
                // 延长精度测试时间以获得更多数据点
                sleep(10000).then(() => {
                    if (webgazer) webgazer.params.storingPoints = false;
                    var past50 = webgazer.getStoredPoints();
                    var precisionPercentage = calculatePrecision(past50);
                    
                    document.getElementById('Accuracy').innerHTML = `测试精度: ${precisionPercentage}%`;
                    eyeTrackingData.calibrationData = {
                        points: CalibrationPoints,
                        accuracyPercentage: precisionPercentage,
                        timestamp: new Date().toISOString(),
                        testDuration: 10000,
                        sampleCount: past50 ? past50[0].length : 0
                    };
                    
                    debug(`校准完成，精度: ${precisionPercentage}%, 样本数: ${past50 ? past50[0].length : 0}`);
                    
                    let acceptThreshold = 70; // 提高接受阈值
                    let recommendRecalibration = precisionPercentage < acceptThreshold;
                    
                    swal({
                        title: `您的追踪精度为 ${precisionPercentage}%`,
                        text: recommendRecalibration ? 
                            `精度低于${acceptThreshold}%，建议重新校准以获得更准确的热力图。` : 
                            "精度良好，可以开始实验。",
                        allowOutsideClick: false,
                        buttons: { cancel: "重新校准", confirm: recommendRecalibration ? "强制接受" : "接受" }
                    }).then(isConfirm => {
                        document.getElementById('statsPanel').style.display = 'block';
                        document.querySelector('.controls').style.display = 'block';
                        if (isConfirm) {
                            ClearCanvas();
                            updateStatus('运行中', 'ready');
                            // 校准完成，重置校准状态和数据缓冲区
                            isCalibrating = false;
                            gazeBuffer = [];
                            lastValidGaze = null;
                            debug('校准接受，重置数据缓冲区');
                        } else {
                            document.getElementById("Accuracy").innerHTML = "等待校准...";
                            webgazer.clearData();
                            Restart();
                        }
                    });
                });
            });
        }

        // 新增：热力图重新初始化函数
        function reinitializeHeatmap() {
            const heatmapContainer = document.getElementById('heatmapContainer');
            if (heatmapInstance) {
                // 保存当前数据
                const currentData = heatmapInstance.getData();
                
                // 重新创建热力图实例
                heatmapInstance = h337.create({ 
                    container: heatmapContainer, 
                    radius: Math.max(15, Math.min(50, window.innerWidth / 40)), 
                    maxOpacity: 0.8, 
                    minOpacity: 0.1, 
                    blur: 0.85,
                    gradient: {
                        '.4': 'blue',
                        '.6': 'cyan',
                        '.7': 'lime',
                        '.8': 'yellow',
                        '1.0': 'red'
                    }
                });
                
                // 恢复数据
                if (currentData && currentData.data) {
                    heatmapInstance.setData(currentData);
                }
                
                debug(`热力图重新初始化: ${window.innerWidth}x${window.innerHeight}, radius=${Math.max(15, Math.min(50, window.innerWidth / 40))}`);
            }
        }

        // 修改系统初始化函数
        async function initializeSystem() {
            try {
                if (typeof h337 === 'undefined' || typeof swal === 'undefined') throw new Error('依赖库加载失败');
                if (!await loadWebGazerScript() || typeof webgazer === 'undefined') throw new Error('WebGazer加载失败');
                
                // 初始化热力图
                heatmapInstance = h337.create({ 
                    container: document.getElementById('heatmapContainer'), 
                    radius: Math.max(15, Math.min(50, window.innerWidth / 40)), 
                    maxOpacity: 0.8, 
                    minOpacity: 0.1, 
                    blur: 0.85,
                    gradient: {
                        '.4': 'blue',
                        '.6': 'cyan',
                        '.7': 'lime',
                        '.8': 'yellow',
                        '1.0': 'red'
                    }
                });
                
                await testFirebaseConnection();
                updateStatus('系统就绪', 'ready');
                document.getElementById('startBtn').disabled = false;
                librariesLoaded = true;
                ClearCanvas();
                setupVideoPlayer();
                
                // 监听窗口大小变化，重新初始化热力图
                window.addEventListener('resize', () => {
                    setTimeout(reinitializeHeatmap, 100);
                });
                
                debug('系统初始化完成，热力图已配置');
            } catch (error) {
                updateStatus('初始化失败', 'error');
                swal('严重错误', `系统初始化失败:\n\n${error.message}`, 'error');
            }
        }

        async function startEyeTracking() {
            if (!librariesLoaded) return;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            updateStatus('初始化WebGazer...', 'initializing');
            try {
                // 修复WebGazer初始化配置
                await webgazer
                    .setRegression('ridge') // 使用ridge回归，更稳定
                    .setTracker('clmtrackr') // 使用clmtrackr追踪器
                    .setGazeListener(gazeDataCallback)
                    .begin();

                // 等待WebGazer完全准备就绪
                await new Promise((resolve) => {
                    const checkReady = () => {
                        if (webgazer.isReady()) {
                            resolve();
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    checkReady();
                });

                // 配置WebGazer参数以提高精度
                webgazer.showVideoPreview(true)
                        .showPredictionPoints(true)
                        .applyKalmanFilter(true); // 启用卡尔曼滤波器

                // 设置更严格的参数
                if (webgazer.params) {
                    webgazer.params.imgWidth = 320;
                    webgazer.params.imgHeight = 240;
                    webgazer.params.faceFinder = true;
                }

                // 重置数据缓冲区
                gazeBuffer = [];
                lastValidGaze = null;
                
                isTracking = true; 
                startTime = Date.now(); 
                webgazerReady = true;
                
                if (firebaseConnected) startAutoSave();
                startHeatmapSnapshots(); 
                startStatsUpdate();
                updateStatus('运行中', 'ready');
                document.getElementById('calibrateBtn').disabled = false;
                startBtn.textContent = '✅ 运行中';
                
                debug('WebGazer初始化完成，添加了注视点过滤和平滑处理');
                swal('启动成功', '眼动追踪已启动！\n已启用数据过滤和平滑处理。\n强烈建议您点击"开始校准"以提高精度。', 'success');
            } catch (error) {
                console.error("启动眼动追踪失败:", error);
                updateStatus('启动失败', 'error');
                startBtn.disabled = false;
                swal('启动失败', `无法启动眼动追踪。\n请检查摄像头权限。\n\n${error.message}`, 'error');
            }
        }

        // 修复校准流程 - 添加更多校准点以提高精度
        function PopUpInstruction() {
            if (!isTracking) return swal('提示', '请先启动眼动追踪。', 'info');
            
            // 设置校准状态标志
            isCalibrating = true;
            
            // 清除之前的数据缓冲区
            gazeBuffer = [];
            lastValidGaze = null;
            
            document.getElementById('statsPanel').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';
            ClearCanvas();
            swal({
                title:"校准说明",
                text: "请点击屏幕上出现的9个点。您必须在每个点上点击5次，直到它变成黄色。请保持头部稳定，仔细注视每个点。校准质量直接影响热力图准确性。",
                buttons:{ cancel: false, confirm: "开始" }
            }).then(() => {
                updateStatus('校准进行中', 'calibrating');
                debug('开始9点校准流程，已清除数据缓冲区');
                ShowCalibrationPoint();
                document.querySelectorAll('.Calibration').forEach((i) => { i.onclick = () => calPointClick(i); });
            });
        }

        function calcAccuracy() {
            swal({
                title: "正在计算精度",
                text: "请不要移动您的鼠标和头部，并尽力注视屏幕中央的点10秒钟。这将帮助我们计算预测的准确性。",
                closeOnEsc: false, allowOutsideClick: false, closeModal: true
            }).then(() => {
                updateStatus('精度测试中...', 'calibrating');
                if (webgazer) webgazer.params.storingPoints = true;
                
                // 延长精度测试时间以获得更多数据点
                sleep(10000).then(() => {
                    if (webgazer) webgazer.params.storingPoints = false;
                    var past50 = webgazer.getStoredPoints();
                    var precisionPercentage = calculatePrecision(past50);
                    
                    document.getElementById('Accuracy').innerHTML = `测试精度: ${precisionPercentage}%`;
                    eyeTrackingData.calibrationData = {
                        points: CalibrationPoints,
                        accuracyPercentage: precisionPercentage,
                        timestamp: new Date().toISOString(),
                        testDuration: 10000,
                        sampleCount: past50 ? past50[0].length : 0
                    };
                    
                    debug(`校准完成，精度: ${precisionPercentage}%, 样本数: ${past50 ? past50[0].length : 0}`);
                    
                    let acceptThreshold = 70; // 提高接受阈值
                    let recommendRecalibration = precisionPercentage < acceptThreshold;
                    
                    swal({
                        title: `您的追踪精度为 ${precisionPercentage}%`,
                        text: recommendRecalibration ? 
                            `精度低于${acceptThreshold}%，建议重新校准以获得更准确的热力图。` : 
                            "精度良好，可以开始实验。",
                        allowOutsideClick: false,
                        buttons: { cancel: "重新校准", confirm: recommendRecalibration ? "强制接受" : "接受" }
                    }).then(isConfirm => {
                        document.getElementById('statsPanel').style.display = 'block';
                        document.querySelector('.controls').style.display = 'block';
                        if (isConfirm) {
                            ClearCanvas();
                            updateStatus('运行中', 'ready');
                            // 校准完成，重置校准状态和数据缓冲区
                            isCalibrating = false;
                            gazeBuffer = [];
                            lastValidGaze = null;
                            debug('校准接受，重置数据缓冲区');
                        } else {
                            document.getElementById("Accuracy").innerHTML = "等待校准...";
                            webgazer.clearData();
                            Restart();
                        }
                    });
                });
            });
        }

        // 新增：热力图重新初始化函数
        function reinitializeHeatmap() {
            const heatmapContainer = document.getElementById('heatmapContainer');
            if (heatmapInstance) {
                // 保存当前数据
                const currentData = heatmapInstance.getData();
                
                // 重新创建热力图实例
                heatmapInstance = h337.create({ 
                    container: heatmapContainer, 
                    radius: Math.max(15, Math.min(50, window.innerWidth / 40)), 
                    maxOpacity: 0.8, 
                    minOpacity: 0.1, 
                    blur: 0.85,
                    gradient: {
                        '.4': 'blue',
                        '.6': 'cyan',
                        '.7': 'lime',
                        '.8': 'yellow',
                        '1.0': 'red'
                    }
                });
                
                // 恢复数据
                if (currentData && currentData.data) {
                    heatmapInstance.setData(currentData);
                }
                
                debug(`热力图重新初始化: ${window.innerWidth}x${window.innerHeight}, radius=${Math.max(15, Math.min(50, window.innerWidth / 40))}`);
            }
        }

        // 修改系统初始化函数
        async function initializeSystem() {
            try {
                if (typeof h337 === 'undefined' || typeof swal === 'undefined') throw new Error('依赖库加载失败');
                if (!await loadWebGazerScript() || typeof webgazer === 'undefined') throw new Error('WebGazer加载失败');
                
                // 初始化热力图
                heatmapInstance = h337.create({ 
                    container: document.getElementById('heatmapContainer'), 
                    radius: Math.max(15, Math.min(50, window.innerWidth / 40)), 
                    maxOpacity: 0.8, 
                    minOpacity: 0.1, 
                    blur: 0.85,
                    gradient: {
                        '.4': 'blue',
                        '.6': 'cyan',
                        '.7': 'lime',
                        '.8': 'yellow',
                        '1.0': 'red'
                    }
                });
                
                await testFirebaseConnection();
                updateStatus('系统就绪', 'ready');
                document.getElementById('startBtn').disabled = false;
                librariesLoaded = true;
                ClearCanvas();
                setupVideoPlayer();
                
                // 监听窗口大小变化，重新初始化热力图
                window.addEventListener('resize', () => {
                    setTimeout(reinitializeHeatmap, 100);
                });
                
                debug('系统初始化完成，热力图已配置');
            } catch (error) {
                updateStatus('初始化失败', 'error');
                swal('严重错误', `系统初始化失败:\n\n${error.message}`, 'error');
            }
        }

        async function startEyeTracking() {
            if (!librariesLoaded) return;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            updateStatus('初始化WebGazer...', 'initializing');
            try {
                // 修复WebGazer初始化配置
                await webgazer
                    .setRegression('ridge') // 使用ridge回归，更稳定
                    .setTracker('clmtrackr') // 使用clmtrackr追踪器
                    .setGazeListener(gazeDataCallback)
                    .begin();

                // 等待WebGazer完全准备就绪
                await new Promise((resolve) => {
                    const checkReady = () => {
                        if (webgazer.isReady()) {
                            resolve();
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    checkReady();
                });

                // 配置WebGazer参数以提高精度
                webgazer.showVideoPreview(true)
                        .showPredictionPoints(true)
                        .applyKalmanFilter(true); // 启用卡尔曼滤波器

                // 设置更严格的参数
                if (webgazer.params) {
                    webgazer.params.imgWidth = 320;
                    webgazer.params.imgHeight = 240;
                    webgazer.params.faceFinder = true;
                }

                // 重置数据缓冲区
                gazeBuffer = [];
                lastValidGaze = null;
                
                isTracking = true; 
                startTime = Date.now(); 
                webgazerReady = true;
                
                if (firebaseConnected) startAutoSave();
                startHeatmapSnapshots(); 
                startStatsUpdate();
                updateStatus('运行中', 'ready');
                document.getElementById('calibrateBtn').disabled = false;
                startBtn.textContent = '✅ 运行中';
                
                debug('WebGazer初始化完成，添加了注视点过滤和平滑处理');
                swal('启动成功', '眼动追踪已启动！\n已启用数据过滤和平滑处理。\n强烈建议您点击"开始校准"以提高精度。', 'success');
            } catch (error) {
                console.error("启动眼动追踪失败:", error);
                updateStatus('启动失败', 'error');
                startBtn.disabled = false;
                swal('启动失败', `无法启动眼动追踪。\n请检查摄像头权限。\n\n${error.message}`, 'error');
            }
        }

        // 修复校准流程 - 添加更多校准点以提高精度
        function PopUpInstruction() {
            if (!isTracking) return swal('提示', '请先启动眼动追踪。', 'info');
            
            // 设置校准状态标志
            isCalibrating = true;
            
            // 清除之前的数据缓冲区
            gazeBuffer = [];
            lastValidGaze = null;
            
            document.getElementById('statsPanel').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';
            ClearCanvas();
            swal({
                title:"校准说明",
                text: "请点击屏幕上出现的9个点。您必须在每个点上点击5次，直到它变成黄色。请保持头部稳定，仔细注视每个点。校准质量直接影响热力图准确性。",
                buttons:{ cancel: false, confirm: "开始" }
            }).then(() => {
                updateStatus('校准进行中', 'calibrating');
                debug('开始9点校准流程，已清除数据缓冲区');
                ShowCalibrationPoint();
                document.querySelectorAll('.Calibration').forEach((i) => { i.onclick = () => calPointClick(i); });
            });
        }

        function calcAccuracy() {
            swal({
                title: "正在计算精度",
                text: "请不要移动您的鼠标和头部，并尽力注视屏幕中央的点10秒钟。这将帮助我们计算预测的准确性。",
                closeOnEsc: false, allowOutsideClick: false, closeModal: true
            }).then(() => {
                updateStatus('精度测试中...', 'calibrating');
                if (webgazer) webgazer.params.storingPoints = true;
                
                // 延长精度测试时间以获得更多数据点
                sleep(10000).then(() => {
                    if (webgazer) webgazer.params.storingPoints = false;
                    var past50 = webgazer.getStoredPoints();
                    var precisionPercentage = calculatePrecision(past50);
                    
                    document.getElementById('Accuracy').innerHTML = `测试精度: ${precisionPercentage}%`;
                    eyeTrackingData.calibrationData = {
                        points: CalibrationPoints,
                        accuracyPercentage: precisionPercentage,
                        timestamp: new Date().toISOString(),
                        testDuration: 10000,
                        sampleCount: past50 ? past50[0].length : 0
                    };
                    
                    debug(`校准完成，精度: ${precisionPercentage}%, 样本数: ${past50 ? past50[0].length : 0}`);
                    
                    let acceptThreshold = 70; // 提高接受阈值
                    let recommendRecalibration = precisionPercentage < acceptThreshold;
                    
                    swal({
                        title: `您的追踪精度为 ${precisionPercentage}%`,
                        text: recommendRecalibration ? 
                            `精度低于${acceptThreshold}%，建议重新校准以获得更准确的热力图。` : 
                            "精度良好，可以开始实验。",
                        allowOutsideClick: false,
                        buttons: { cancel: "重新校准", confirm: recommendRecalibration ? "强制接受" : "接受" }
                    }).then(isConfirm => {
                        document.getElementById('statsPanel').style.display = 'block';
                        document.querySelector('.controls').style.display = 'block';
                        if (isConfirm) {
                            ClearCanvas();
                            updateStatus('运行中', 'ready');
                            // 校准完成，重置校准状态和数据缓冲区
                            isCalibrating = false;
                            gazeBuffer = [];
                            lastValidGaze = null;
                            debug('校准接受，重置数据缓冲区');
                        } else {
                            document.getElementById("Accuracy").innerHTML = "等待校准...";
                            webgazer.clearData();
                            Restart();
                        }
                    });
                });
            });
        }

        // 新增：热力图重新初始化函数
        function reinitializeHeatmap() {
            const heatmapContainer = document.getElementById('heatmapContainer');
            if (heatmapInstance) {
                // 保存当前数据
                const currentData = heatmapInstance.getData();
                
                // 重新创建热力图实例
                heatmapInstance = h337.create({ 
                    container: heatmapContainer, 
                    radius: Math.max(15, Math.min(50, window.innerWidth / 40)), 
                    maxOpacity: 0.8, 
                    minOpacity: 0.1, 
                    blur: 0.85,
                    gradient: {
                        '.4': 'blue',
                        '.6': 'cyan',
                        '.7': 'lime',
                        '.8': 'yellow',
                        '1.0': 'red'
                    }
                });
                
                // 恢复数据
                if (currentData && currentData.data) {
                    heatmapInstance.setData(currentData);
                }
                
                debug(`热力图重新初始化: ${window.innerWidth}x${window.innerHeight}, radius=${Math.max(15, Math.min(50, window.innerWidth / 40))}`);
            }
        }

        // 修改系统初始化函数
        async function initializeSystem() {
            try {
                if (typeof h337 === 'undefined' || typeof swal === 'undefined') throw new Error('依赖库加载失败');
                if (!await loadWebGazerScript() || typeof webgazer === 'undefined') throw new Error('WebGazer加载失败');
                
                // 初始化热力图
                heatmapInstance = h337.create({ 
                    container: document.getElementById('heatmapContainer'), 
                    radius: Math.max(15, Math.min(50, window.innerWidth / 40)), 
                    maxOpacity: 0.8, 
                    minOpacity: 0.1, 
                    blur: 0.85,
                    gradient: {
                        '.4': 'blue',
                        '.6': 'cyan',
                        '.7': 'lime',
                        '.8': 'yellow',
                        '1.0': 'red'
                    }
                });
                
                await testFirebaseConnection();
                updateStatus('系统就绪', 'ready');
                document.getElementById('startBtn').disabled = false;
                librariesLoaded = true;
                ClearCanvas();
                setupVideoPlayer();
                
                // 监听窗口大小变化，重新初始化热力图
                window.addEventListener('resize', () => {
                    setTimeout(reinitializeHeatmap, 100);
                });
                
                debug('系统初始化完成，热力图已配置');
            } catch (error) {
                updateStatus('初始化失败', 'error');
                swal('严重错误', `系统初始化失败:\n\n${error.message}`, 'error');
            }
        }

        async function startEyeTracking() {
            if (!librariesLoaded) return;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            updateStatus('初始化WebGazer...', 'initializing');
            try {
                // 修复WebGazer初始化配置
                await webgazer
                    .setRegression('ridge') // 使用ridge回归，更稳定
                    .setTracker('clmtrackr') // 使用clmtrackr追踪器
                    .setGazeListener(gazeDataCallback)
                    .begin();

                // 等待WebGazer完全准备就绪
                await new Promise((resolve) => {
                    const checkReady = () => {
                        if (webgazer.isReady()) {
                            resolve();
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    checkReady();
                });

                // 配置WebGazer参数以提高精度
                webgazer.showVideoPreview(true)
                        .showPredictionPoints(true)
                        .applyKalmanFilter(true); // 启用卡尔曼滤波器

                // 设置更严格的参数
                if (webgazer.params) {
                    webgazer.params.imgWidth = 320;
                    webgazer.params.imgHeight = 240;
                    webgazer.params.faceFinder = true;
                }

                // 重置数据缓冲区
                gazeBuffer = [];
                lastValidGaze = null;
                
                isTracking = true; 
                startTime = Date.now(); 
                webgazerReady = true;
                
                if (firebaseConnected) startAutoSave();
                startHeatmapSnapshots(); 
                startStatsUpdate();
                updateStatus('运行中', 'ready');
                document.getElementById('calibrateBtn').disabled = false;
                startBtn.textContent = '✅ 运行中';
                
                debug('WebGazer初始化完成，添加了注视点过滤和平滑处理');
                swal('启动成功', '眼动追踪已启动！\n已启用数据过滤和平滑处理。\n强烈建议您点击"开始校准"以提高精度。', 'success');
            } catch (error) {
                console.error("启动眼动追踪失败:", error);
                updateStatus('启动失败', 'error');
                startBtn.disabled = false;
                swal('启动失败', `无法启动眼动追踪。\n请检查摄像头权限。\n\n${error.message}`, 'error');
            }
        }

        // 修复校准流程 - 添加更多校准点以提高精度
        function PopUpInstruction() {
            if (!isTracking) return swal('提示', '请先启动眼动追踪。', 'info');
            
            // 设置校准状态标志
            isCalibrating = true;
            
            // 清除之前的数据缓冲区
            gazeBuffer = [];
            lastValidGaze = null;
            
            document.getElementById('statsPanel').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';
            ClearCanvas();
            swal({
                title:"校准说明",
                text: "请点击屏幕上出现的9个点。您必须在每个点上点击5次，直到它变成黄色。请保持头部稳定，仔细注视每个点。校准质量直接影响热力图准确性。",
                buttons:{ cancel: false, confirm: "开始" }
            }).then(() => {
                updateStatus('校准进行中', 'calibrating');
                debug('开始9点校准流程，已清除数据缓冲区');
                ShowCalibrationPoint();
                document.querySelectorAll('.Calibration').forEach((i) => { i.onclick = () => calPointClick(i); });
            });
        }

        function calcAccuracy() {
            swal({
                title: "正在计算精度",
                text: "请不要移动您的鼠标和头部，并尽力注视屏幕中央的点10秒钟。这将帮助我们计算预测的准确性。",
                closeOnEsc: false, allowOutsideClick: false, closeModal: true
            }).then(() => {
                updateStatus('精度测试中...', 'calibrating');
                if (webgazer) webgazer.params.storingPoints = true;
                
                // 延长精度测试时间以获得更多数据点
                sleep(10000).then(() => {
                    if (webgazer) webgazer.params.storingPoints = false;
                    var past50 = webgazer.getStoredPoints();
                    var precisionPercentage = calculatePrecision(past50);
                    
                    document.getElementById('Accuracy').innerHTML = `测试精度: ${precisionPercentage}%`;
                    eyeTrackingData.calibrationData = {
                        points: CalibrationPoints,
                        accuracyPercentage: precisionPercentage,
                        timestamp: new Date().toISOString(),
                        testDuration: 10000,
                        sampleCount: past50 ? past50[0].length : 0
                    };
                    
                    debug(`校准完成，精度: ${precisionPercentage}%, 样本数: ${past50 ? past50[0].length : 0}`);
                    
                    let acceptThreshold = 70; // 提高接受阈值
                    let recommendRecalibration = precisionPercentage < acceptThreshold;
                    
                    swal({
                        title: `您的追踪精度为 ${precisionPercentage}%`,
                        text: recommendRecalibration ? 
                            `精度低于${acceptThreshold}%，建议重新校准以获得更准确的热力图。` : 
                            "精度良好，可以开始实验。",
                        allowOutsideClick: false,
                        buttons: { cancel: "重新校准", confirm: recommendRecalibration ? "强制接受" : "接受" }
                    }).then(isConfirm => {
                        document.getElementById('statsPanel').style.display = 'block';
                        document.querySelector('.controls').style.display = 'block';
                        if (isConfirm) {
                            ClearCanvas();
                            updateStatus('运行中', 'ready');
                            // 校准完成，重置校准状态和数据缓冲区
                            isCalibrating = false;
                            gazeBuffer = [];
                            lastValidGaze = null;
                            debug('校准接受，重置数据缓冲区');
                        } else {
                            document.getElementById("Accuracy").innerHTML = "等待校准...";
                            webgazer.clearData();
                            Restart();
                        }
                    });
                });
            });
        }

        // 新增：热力图重新初始化函数
        function reinitializeHeatmap() {
            const heatmapContainer = document.getElementById('heatmapContainer');
            if (heatmapInstance) {
                // 保存当前数据
                const currentData = heatmapInstance.getData();
                
                // 重新创建热力图实例
                heatmapInstance = h337.create({ 
                    container: heatmapContainer, 
                    radius: Math.max(15, Math.min(50, window.innerWidth / 40)), 
                    maxOpacity: 0.8, 
                    minOpacity: 0.1, 
                    blur: 0.85,
                    gradient: {
                        '.4': 'blue',
                        '.6': 'cyan',
                        '.7': 'lime',
                        '.8': 'yellow',
                        '1.0': 'red'
                    }
                });
                
                // 恢复数据
                if (currentData && currentData.data) {
                    heatmapInstance.setData(currentData);
                }
                
                debug(`热力图重新初始化: ${window.innerWidth}x${window.innerHeight}, radius=${Math.max(15, Math.min(50, window.innerWidth / 40))}`);
            }
        }

        // 修改系统初始化函数
        async function initializeSystem() {
            try {
                if (typeof h337 === 'undefined' || typeof swal === 'undefined') throw new Error('依赖库加载失败');
                if (!await loadWebGazerScript() || typeof webgazer === 'undefined') throw new Error('WebGazer加载失败');
                
                // 初始化热力图
                heatmapInstance = h337.create({ 
                    container: document.getElementById('heatmapContainer'), 
                    radius: Math.max(15, Math.min(50, window.innerWidth / 40)), 
                    maxOpacity: 0.8, 
                    minOpacity: 0.1, 
                    blur: 0.85,
                    gradient: {
                        '.4': 'blue',
                        '.6': 'cyan',
                        '.7': 'lime',
                        '.8': 'yellow',
                        '1.0': 'red'
                    }
                });
                
                await testFirebaseConnection();
                updateStatus('系统就绪', 'ready');
                document.getElementById('startBtn').disabled = false;
                librariesLoaded = true;
                ClearCanvas();
                setupVideoPlayer();
                
                // 监听窗口大小变化，重新初始化热力图
                window.addEventListener('resize', () => {
                    setTimeout(reinitializeHeatmap, 100);
                });
                
                debug('系统初始化完成，热力图已配置');
            } catch (error) {
                updateStatus('初始化失败', 'error');
                swal('严重错误', `系统初始化失败:\n\n${error.message}`, 'error');
            }
        }

        async function startEyeTracking() {
            if (!librariesLoaded) return;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            updateStatus('初始化WebGazer...', 'initializing');
            try {
                // 修复WebGazer初始化配置
                await webgazer
                    .setRegression('ridge') // 使用ridge回归，更稳定
                    .setTracker('clmtrackr') // 使用clmtrackr追踪器
                    .setGazeListener(gazeDataCallback)
                    .begin();

                // 等待WebGazer完全准备就绪
                await new Promise((resolve) => {
                    const checkReady = () => {
                        if (webgazer.isReady()) {
                            resolve();
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    checkReady();
                });

                // 配置WebGazer参数以提高精度
                webgazer.showVideoPreview(true)
                        .showPredictionPoints(true)
                        .applyKalmanFilter(true); // 启用卡尔曼滤波器

                // 设置更严格的参数
                if (webgazer.params) {
                    webgazer.params.imgWidth = 320;
                    webgazer.params.imgHeight = 240;
                    webgazer.params.faceFinder = true;
                }

                // 重置数据缓冲区
                gazeBuffer = [];
                lastValidGaze = null;
                
                isTracking = true; 
                startTime = Date.now(); 
                webgazerReady = true;
                
                if (firebaseConnected) startAutoSave();
                startHeatmapSnapshots(); 
                startStatsUpdate();
                updateStatus('运行中', 'ready');
                document.getElementById('calibrateBtn').disabled = false;
                startBtn.textContent = '✅ 运行中';
                
                debug('WebGazer初始化完成，添加了注视点过滤和平滑处理');
                swal('启动成功', '眼动追踪已启动！\n已启用数据过滤和平滑处理。\n强烈建议您点击"开始校准"以提高精度。', 'success');
            } catch (error) {
                console.error("启动眼动追踪失败:", error);
                updateStatus('启动失败', 'error');
                startBtn.disabled = false;
                swal('启动失败', `无法启动眼动追踪。\n请检查摄像头权限。\n\n${error.message}`, 'error');
            }
        }

        // 修复校准流程 - 添加更多校准点以提高精度
        function PopUpInstruction() {
            if (!isTracking) return swal('提示', '请先启动眼动追踪。', 'info');
            
            // 设置校准状态标志
            isCalibrating = true;
            
            // 清除之前的数据缓冲区
            gazeBuffer = [];
            lastValidGaze = null;
            
            document.getElementById('statsPanel').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';
            ClearCanvas();
            swal({
                title:"校准说明",
                text: "请点击屏幕上出现的9个点。您必须在每个点上点击5次，直到它变成黄色。请保持头部稳定，仔细注视每个点。校准质量直接影响热力图准确性。",
                buttons:{ cancel: false, confirm: "开始" }
            }).then(() => {
                updateStatus('校准进行中', 'calibrating');
                debug('开始9点校准流程，已清除数据缓冲区');
                ShowCalibrationPoint();
                document.querySelectorAll('.Calibration').forEach((i) => { i.onclick = () => calPointClick(i); });
            });
        }

        function calcAccuracy() {
            swal({
                title: "正在计算精度",
                text: "请不要移动您的鼠标和头部，并尽力注视屏幕中央的点10秒钟。这将帮助我们计算预测的准确性。",
                closeOnEsc: false, allowOutsideClick: false, closeModal: true
            }).then(() => {
                updateStatus('精度测试中...', 'calibrating');
                if (webgazer) webgazer.params.storingPoints = true;
                
                // 延长精度测试时间以获得更多数据点
                sleep(10000).then(() => {
                    if (webgazer) webgazer.params.storingPoints = false;
                    var past50 = webgazer.getStoredPoints();
                    var precisionPercentage = calculatePrecision(past50);
                    
                    document.getElementById('Accuracy').innerHTML = `测试精度: ${precisionPercentage}%`;
                    eyeTrackingData.calibrationData = {
                        points: CalibrationPoints,
                        accuracyPercentage: precisionPercentage,
                        timestamp: new Date().toISOString(),
                        testDuration: 10000,
                        sampleCount: past50 ? past50[0].length : 0
                    };
                    
                    debug(`校准完成，精度: ${precisionPercentage}%, 样本数: ${past50 ? past50[0].length : 0}`);
                    
                    let acceptThreshold = 70; // 提高接受阈值
                    let recommendRecalibration = precisionPercentage < acceptThreshold;
                    
                    swal({
                        title: `您的追踪精度为 ${precisionPercentage}%`,
                        text: recommendRecalibration ? 
                            `精度低于${acceptThreshold}%，建议重新校准以获得更准确的热力图。` : 
                            "精度良好，可以开始实验。",
                        allowOutsideClick: false,
                        buttons: { cancel: "重新校准", confirm: recommendRecalibration ? "强制接受" : "接受" }
                    }).then(isConfirm => {
                        document.getElementById('statsPanel').style.display = 'block';
                        document.querySelector('.controls').style.display = 'block';
                        if (isConfirm) {
                            ClearCanvas();
                            updateStatus('运行中', 'ready');
                            // 校准完成，重置校准状态和数据缓冲区
                            isCalibrating = false;
                            gazeBuffer = [];
                            lastValidGaze = null;
                            debug('校准接受，重置数据缓冲区');
                        } else {
                            document.getElementById("Accuracy").innerHTML = "等待校准...";
                            webgazer.clearData();
                            Restart();
                        }
                    });
                });
            });
        }

        // 新增：热力图重新初始化函数
        function reinitializeHeatmap() {
            const heatmapContainer = document.getElementById('heatmapContainer');
            if (heatmapInstance) {
                // 保存当前数据
                const currentData = heatmapInstance.getData();
                
                // 重新创建热力图实例
                heatmapInstance = h337.create({ 
                    container: heatmapContainer, 
                    radius: Math.max(15, Math.min(50, window.innerWidth / 40)), 
                    maxOpacity: 0.8, 
                    minOpacity: 0.1, 
                    blur: 0.85,
                    gradient: {
                        '.4': 'blue',
                        '.6': 'cyan',
                        '.7': 'lime',
                        '.8': 'yellow',
                        '1.0': 'red'
                    }
                });
                
                // 恢复数据
                if (currentData && currentData.data) {
                    heatmapInstance.setData(currentData);
                }
                
                debug(`热力图重新初始化: ${window.innerWidth}x${window.innerHeight}, radius=${Math.max(15, Math.min(50, window.innerWidth / 40))}`);
            }
        }

        // 修改系统初始化函数
        async function initializeSystem() {
            try {
                if (typeof h337 === 'undefined' || typeof swal === 'undefined') throw new Error('依赖库加载失败');
                if (!await loadWebGazerScript() || typeof webgazer === 'undefined') throw new Error('WebGazer加载失败');
                
                // 初始化热力图
                heatmapInstance = h337.create({ 
                    container: document.getElementById('heatmapContainer'), 
                    radius: Math.max(15, Math.min(50, window.innerWidth / 40)), 
                    maxOpacity: 0.8, 
                    minOpacity: 0.1, 
                    blur: 0.85,
                    gradient: {
                        '.4': 'blue',
                        '.6': 'cyan',
                        '.7': 'lime',
                        '.8': 'yellow',
                        '1.0': 'red'
                    }
                });
                
                await testFirebaseConnection();
                updateStatus('系统就绪', 'ready');
                document.getElementById('startBtn').disabled = false;
                librariesLoaded = true;
                ClearCanvas();
                setupVideoPlayer();
                
                // 监听窗口大小变化，重新初始化热力图
                window.addEventListener('resize', () => {
                    setTimeout(reinitializeHeatmap, 100);
                });
                
                debug('系统初始化完成，热力图已配置');
            } catch (error) {
                updateStatus('初始化失败', 'error');
                swal('严重错误', `系统初始化失败:\n\n${error.message}`, 'error');
            }
        }

        async function startEyeTracking() {
            if (!librariesLoaded) return;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            updateStatus('初始化WebGazer...', 'initializing');
            try {
                // 修复WebGazer初始化配置
                await webgazer
                    .setRegression('ridge') // 使用ridge回归，更稳定
                    .setTracker('clmtrackr') // 使用clmtrackr追踪器
                    .setGazeListener(gazeDataCallback)
                    .begin();

                // 等待WebGazer完全准备就绪
                await new Promise((resolve) => {
                    const checkReady = () => {
                        if (webgazer.isReady()) {
                            resolve();
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    checkReady();
                });

                // 配置WebGazer参数以提高精度
                webgazer.showVideoPreview(true)
                        .showPredictionPoints(true)
                        .applyKalmanFilter(true); // 启用卡尔曼滤波器

                // 设置更严格的参数
                if (webgazer.params) {
                    webgazer.params.imgWidth = 320;
                    webgazer.params.imgHeight = 240;
                    webgazer.params.faceFinder = true;
                }

                // 重置数据缓冲区
                gazeBuffer = [];
                lastValidGaze = null;
                
                isTracking = true; 
                startTime = Date.now(); 
                webgazerReady = true;
                
                if (firebaseConnected) startAutoSave();
                startHeatmapSnapshots(); 
                startStatsUpdate();
                updateStatus('运行中', 'ready');
                document.getElementById('calibrateBtn').disabled = false;
                startBtn.textContent = '✅ 运行中';
                
                debug('WebGazer初始化完成，添加了注视点过滤和平滑处理');
                swal('启动成功', '眼动追踪已启动！\n已启用数据过滤和平滑处理。\n强烈建议您点击"开始校准"以提高精度。', 'success');
            } catch (error) {
                console.error("启动眼动追踪失败:", error);
                updateStatus('启动失败', 'error');
                startBtn.disabled = false;
                swal('启动失败', `无法启动眼动追踪。\n请检查摄像头权限。\n\n${error.message}`, 'error');
            }
        }

        // 修复校准流程 - 添加更多校准点以提高精度
        function PopUpInstruction() {
            if (!isTracking) return swal('提示', '请先启动眼动追踪。', 'info');
            
            // 设置校准状态标志
            isCalibrating = true;
            
            // 清除之前的数据缓冲区
            gazeBuffer = [];
            lastValidGaze = null;
            
            document.getElementById('statsPanel').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';
            ClearCanvas();
            swal({
                title:"校准说明",
                text: "请点击屏幕上出现的9个点。您必须在每个点上点击5次，直到它变成黄色。请保持头部稳定，仔细注视每个点。校准质量直接影响热力图准确性。",
                buttons:{ cancel: false, confirm: "开始" }
            }).then(() => {
                updateStatus('校准进行中', 'calibrating');
                debug('开始9点校准流程，已清除数据缓冲区');
                ShowCalibrationPoint();
                document.querySelectorAll('.Calibration').forEach((i) => { i.onclick = () => calPointClick(i); });
            });
        }

        function calcAccuracy() {
            swal({
                title: "正在计算精度",
                text: "请不要移动您的鼠标和头部，并尽力注视屏幕中央的点10秒钟。这将帮助我们计算预测的准确性。",
                closeOnEsc: false, allowOutsideClick: false, closeModal: true
            }).then(() => {
                updateStatus('精度测试中...', 'calibrating');
                if (webgazer) webgazer.params.storingPoints = true;
                
                // 延长精度测试时间以获得更多数据点
                sleep(10000).then(() => {
                    if (webgazer) webgazer.params.storingPoints = false;
                    var past50 = webgazer.getStoredPoints();
                    var precisionPercentage = calculatePrecision(past50);
                    
                    document.getElementById('Accuracy').innerHTML = `测试精度: ${precisionPercentage}%`;
                    eyeTrackingData.calibrationData = {
                        points: CalibrationPoints,
                        accuracyPercentage: precisionPercentage,
                        timestamp: new Date().toISOString(),
                        testDuration: 10000,
                        sampleCount: past50 ? past50[0].length : 0
                    };
                    
                    debug(`校准完成，精度: ${precisionPercentage}%, 样本数: ${past50 ? past50[0].length : 0}`);
                    
                    let acceptThreshold = 70; // 提高接受阈值
                    let recommendRecalibration = precisionPercentage < acceptThreshold;
                    
                    swal({
                        title: `您的追踪精度为 ${precisionPercentage}%`,
                        text: recommendRecalibration ? 
                            `精度低于${acceptThreshold}%，建议重新校准以获得更准确的热力图。` : 
                            "精度良好，可以开始实验。",
                        allowOutsideClick: false,
                        buttons: { cancel: "重新校准", confirm: recommendRecalibration ? "强制接受" : "接受" }
                    }).then(isConfirm => {
                        document.getElementById('statsPanel').style.display = 'block';
                        document.querySelector('.controls').style.display = 'block';
                        if (isConfirm) {
                            ClearCanvas();
                            updateStatus('运行中', 'ready');
                            // 校准完成，重置校准状态和数据缓冲区
                            isCalibrating = false;
                            gazeBuffer = [];
                            lastValidGaze = null;
                            debug('校准接受，重置数据缓冲区');
                        } else {
                            document.getElementById("Accuracy").innerHTML = "等待校准...";
                            webgazer.clearData();
                            Restart();
                        }
                    });
                });
            });
        }

        // 新增：热力图重新初始化函数
        function reinitializeHeatmap() {
            const heatmapContainer = document.getElementById('heatmapContainer');
            if (heatmapInstance) {
                // 保存当前数据
                const currentData = heatmapInstance.getData();
                
                // 重新创建热力图实例
                heatmapInstance = h337.create({ 
                    container: heatmapContainer, 
                    radius: Math.max(15, Math.min(50, window.innerWidth / 40)), 
                    maxOpacity: 0.8, 
                    minOpacity: 0.1, 
                    blur: 0.85,
                    gradient: {
                        '.4': 'blue',
                        '.6': 'cyan',
                        '.7': 'lime',
                        '.8': 'yellow',
                        '1.0': 'red'
                    }
                });
                
                // 恢复数据
                if (currentData && currentData.data) {
                    heatmapInstance.setData(currentData);
                }
                
                debug(`热力图重新初始化: ${window.innerWidth}x${window.innerHeight}, radius=${Math.max(15, Math.min(50, window.innerWidth / 40))}`);
            }
        }

        // 修改系统初始化函数
        async function initializeSystem() {
            try {
                if (typeof h337 === 'undefined' || typeof swal === 'undefined') throw new Error('依赖库加载失败');
                if (!await loadWebGazerScript() || typeof webgazer === 'undefined') throw new Error('WebGazer加载失败');
                
                // 初始化热力图
                heatmapInstance = h337.create({ 
                    container: document.getElementById('heatmapContainer'), 
                    radius: Math.max(15, Math.min(50, window.innerWidth / 40)), 
                    maxOpacity: 0.8, 
                    minOpacity: 0.1, 
                    blur: 0.85,
                    gradient: {
                        '.4': 'blue',
                        '.6': 'cyan',
                        '.7': 'lime',
                        '.8': 'yellow',
                        '1.0': 'red'
                    }
                });
                
                await testFirebaseConnection();
                updateStatus('系统就绪', 'ready');
                document.getElementById('startBtn').disabled = false;
                librariesLoaded = true;
                ClearCanvas();
                setupVideoPlayer();
                
                // 监听窗口大小变化，重新初始化热力图
                window.addEventListener('resize', () => {
                    setTimeout(reinitializeHeatmap, 100);
                });
                
                debug('系统初始化完成，热力图已配置');
            } catch (error) {
                updateStatus('初始化失败', 'error');
                swal('严重错误', `系统初始化失败:\n\n${error.message}`, 'error');
            }
        }

        window.addEventListener('load', initializeSystem);
        window.addEventListener('error', (e) => debug(`全局错误: ${e.message}`));
        window.addEventListener('unhandledrejection', (e) => debug(`Promise拒绝: ${e.reason}`));
        window.addEventListener('beforeunload', (e) => {
            if (isTracking && eyeTrackingData.gazePoints.length > 0) {
                const message = '您有未保存的数据，确定要离开吗？';
                e.returnValue = message; return message;
            }
        });
        document.addEventListener('visibilitychange', () => {
            if (isTracking && webgazer) {
                document.visibilityState === 'hidden' ? webgazer.pause() : webgazer.resume();
            }
        });
    </script>
</body>
</html>
